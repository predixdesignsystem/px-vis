<script>
(function(){
  if(typeof Px === 'undefined') {
    Px = {};
  }
  Px.vis = Px.vis || {};
  if(!Px.vis.scheduler) {

    window.dispatchEvent(new CustomEvent('px-vis-worker-init'));

    //get number of cores
    var scheduler = {},
        threadCount = Px.vis.maxWorkerCount || navigator.hardwareConcurrency || 4,
        initCounter = 0,
        processDone,
        startWork;

    if(!Px.vis.workerUrl) {
      //start of blob
      var blob =  {"script":"!function(n,t){\"object\"==typeof exports&&\"undefined\"!=typeof module?t(exports,require(\"d3-color\")):\"function\"==typeof define&&define.amd?define([\"exports\",\"d3-color\"],t):t(n.d3={},n.d3Color)}(this,function(n,t){\"use strict\";function e(n,t,e){var r=(t-n)/Math.max(0,e),u=Math.floor(Math.log(r)/Math.LN10),i=r/Math.pow(10,u);return u>=0?(i>=Pn?10:i>=Wn?5:i>=Vn?2:1)*Math.pow(10,u):-Math.pow(10,-u)/(i>=Pn?10:i>=Wn?5:i>=Vn?2:1)}function r(n,t,e){var r=Math.abs(t-n)/Math.max(0,e),u=Math.pow(10,Math.floor(Math.log(r)/Math.LN10)),i=r/u;return i>=Pn?u*=10:i>=Wn?u*=5:i>=Vn&&(u*=2),t<n?-u:u}function u(){}function i(n,t){var e=new u;if(n instanceof u)n.each(function(n,t){e.set(t,n)});else if(Array.isArray(n)){var r,i=-1,o=n.length;if(null==t)for(;++i<o;)e.set(i,n[i]);else for(;++i<o;)e.set(t(r=n[i],i,n),r)}else if(n)for(var a in n)e.set(a,n[a]);return e}function o(){}function a(n){function t(t){var i=t+\"\",o=e.get(i);if(!o){if(u!==Bn)return u;e.set(i,o=r.push(t))}return n[(o-1)%n.length]}var e=i(),r=[],u=Bn;return n=null==n?[]:Jn.call(n),t.domain=function(n){if(!arguments.length)return r.slice();r=[],e=i();for(var u,o,a=-1,c=n.length;++a<c;)e.has(o=(u=n[a])+\"\")||e.set(o,r.push(u));return t},t.range=function(e){return arguments.length?(n=Jn.call(e),t):n.slice()},t.unknown=function(n){return arguments.length?(u=n,t):u},t.copy=function(){return a().domain(r).range(n).unknown(u)},t}function c(){function n(){var n=u().length,r=o[1]<o[0],a=o[r-0],c=o[1-r];t=(c-a)/Math.max(1,n-l+2*s),f&&(t=Math.floor(t)),a+=(c-a-t*(n-l))*h,e=t*(1-l),f&&(a=Math.round(a),e=Math.round(e));var g=Zn(n).map(function(n){return a+t*n});return i(r?g.reverse():g)}var t,e,r=a().unknown(void 0),u=r.domain,i=r.range,o=[0,1],f=!1,l=0,s=0,h=.5;return delete r.unknown,r.domain=function(t){return arguments.length?(u(t),n()):u()},r.range=function(t){return arguments.length?(o=[+t[0],+t[1]],n()):o.slice()},r.rangeRound=function(t){return o=[+t[0],+t[1]],f=!0,n()},r.bandwidth=function(){return e},r.step=function(){return t},r.round=function(t){return arguments.length?(f=!!t,n()):f},r.padding=function(t){return arguments.length?(l=s=Math.max(0,Math.min(1,t)),n()):l},r.paddingInner=function(t){return arguments.length?(l=Math.max(0,Math.min(1,t)),n()):l},r.paddingOuter=function(t){return arguments.length?(s=Math.max(0,Math.min(1,t)),n()):s},r.align=function(t){return arguments.length?(h=Math.max(0,Math.min(1,t)),n()):h},r.copy=function(){return c().domain(u()).range(o).round(f).paddingInner(l).paddingOuter(s).align(h)},n()}function f(n){var t=n.copy;return n.padding=n.paddingOuter,delete n.paddingInner,delete n.paddingOuter,n.copy=function(){return f(t())},n}function l(n){return 1==(n=+n)?s:function(t,e){return e-t?function(n,t,e){return n=Math.pow(n,e),t=Math.pow(t,e)-n,e=1/e,function(r){return Math.pow(n+r*t,e)}}(t,e,n):Rn(isNaN(t)?e:t)}}function s(n,t){var e=t-n;return e?function(n,t){return function(e){return n+e*t}}(n,e):Rn(isNaN(n)?t:n)}function h(n,t,e,r){function u(t){return n(t=new Date(+t)),t}return u.floor=u,u.ceil=function(e){return n(e=new Date(e-1)),t(e,1),n(e),e},u.round=function(n){var t=u(n),e=u.ceil(n);return n-t<e-n?t:e},u.offset=function(n,e){return t(n=new Date(+n),null==e?1:Math.floor(e)),n},u.range=function(e,r,i){var o,a=[];if(e=u.ceil(e),i=null==i?1:Math.floor(i),!(e<r&&i>0))return a;do{a.push(o=new Date(+e)),t(e,i),n(e)}while(o<e&&e<r);return a},u.filter=function(e){return h(function(t){if(t>=t)for(;n(t),!e(t);)t.setTime(t-1)},function(n,r){if(n>=n)if(r<0)for(;++r<=0;)for(;t(n,-1),!e(n););else for(;--r>=0;)for(;t(n,1),!e(n););})},e&&(u.count=function(t,r){return ut.setTime(+t),it.setTime(+r),n(ut),n(it),Math.floor(e(ut,it))},u.every=function(n){return n=Math.floor(n),isFinite(n)&&n>0?n>1?u.filter(r?function(t){return r(t)%n==0}:function(t){return u.count(0,t)%n==0}):u:null}),u}function g(n){return h(function(t){t.setDate(t.getDate()-(t.getDay()+7-n)%7),t.setHours(0,0,0,0)},function(n,t){n.setDate(n.getDate()+7*t)},function(n,t){return(t-n-(t.getTimezoneOffset()-n.getTimezoneOffset())*at)/ct})}function d(n){return h(function(t){t.setUTCDate(t.getUTCDate()-(t.getUTCDay()+7-n)%7),t.setUTCHours(0,0,0,0)},function(n,t){n.setUTCDate(n.getUTCDate()+7*t)},function(n,t){return(t-n)/ct})}function v(n){if(0<=n.y&&n.y<100){var t=new Date(-1,n.m,n.d,n.H,n.M,n.S,n.L);return t.setFullYear(n.y),t}return new Date(n.y,n.m,n.d,n.H,n.M,n.S,n.L)}function y(n){if(0<=n.y&&n.y<100){var t=new Date(Date.UTC(-1,n.m,n.d,n.H,n.M,n.S,n.L));return t.setUTCFullYear(n.y),t}return new Date(Date.UTC(n.y,n.m,n.d,n.H,n.M,n.S,n.L))}function p(n){return{y:n,m:0,d:1,H:0,M:0,S:0,L:0}}function M(n,t,e){var r=n<0?\"-\":\"\",u=(r?-n:n)+\"\",i=u.length;return r+(i<e?new Array(e-i+1).join(t)+u:u)}function m(n){return n.replace(kt,\"\\\\$&\")}function x(n){return new RegExp(\"^(?:\"+n.map(m).join(\"|\")+\")\",\"i\")}function w(n){for(var t={},e=-1,r=n.length;++e<r;)t[n[e].toLowerCase()]=e;return t}function T(n,t,e){var r=Yt.exec(t.slice(e,e+1));return r?(n.w=+r[0],e+r[0].length):-1}function _(n,t,e){var r=Yt.exec(t.slice(e,e+1));return r?(n.u=+r[0],e+r[0].length):-1}function C(n,t,e){var r=Yt.exec(t.slice(e,e+2));return r?(n.U=+r[0],e+r[0].length):-1}function U(n,t,e){var r=Yt.exec(t.slice(e,e+2));return r?(n.V=+r[0],e+r[0].length):-1}function D(n,t,e){var r=Yt.exec(t.slice(e,e+2));return r?(n.W=+r[0],e+r[0].length):-1}function b(n,t,e){var r=Yt.exec(t.slice(e,e+4));return r?(n.y=+r[0],e+r[0].length):-1}function N(n,t,e){var r=Yt.exec(t.slice(e,e+2));return r?(n.y=+r[0]+(+r[0]>68?1900:2e3),e+r[0].length):-1}function A(n,t,e){var r=/^(Z)|([+-]\\d\\d)(?::?(\\d\\d))?/.exec(t.slice(e,e+6));return r?(n.Z=r[1]?0:-(r[2]+(r[3]||\"00\")),e+r[0].length):-1}function F(n,t,e){var r=Yt.exec(t.slice(e,e+2));return r?(n.m=r[0]-1,e+r[0].length):-1}function S(n,t,e){var r=Yt.exec(t.slice(e,e+2));return r?(n.d=+r[0],e+r[0].length):-1}function Y(n,t,e){var r=Yt.exec(t.slice(e,e+3));return r?(n.m=0,n.d=+r[0],e+r[0].length):-1}function H(n,t,e){var r=Yt.exec(t.slice(e,e+2));return r?(n.H=+r[0],e+r[0].length):-1}function k(n,t,e){var r=Yt.exec(t.slice(e,e+2));return r?(n.M=+r[0],e+r[0].length):-1}function L(n,t,e){var r=Yt.exec(t.slice(e,e+2));return r?(n.S=+r[0],e+r[0].length):-1}function $(n,t,e){var r=Yt.exec(t.slice(e,e+3));return r?(n.L=+r[0],e+r[0].length):-1}function j(n,t,e){var r=Yt.exec(t.slice(e,e+6));return r?(n.L=Math.floor(r[0]/1e3),e+r[0].length):-1}function O(n,t,e){var r=Ht.exec(t.slice(e,e+1));return r?e+r[0].length:-1}function z(n,t,e){var r=Yt.exec(t.slice(e));return r?(n.Q=+r[0],e+r[0].length):-1}function I(n,t,e){var r=Yt.exec(t.slice(e));return r?(n.Q=1e3*+r[0],e+r[0].length):-1}function Z(n,t){return M(n.getDate(),t,2)}function P(n,t){return M(n.getHours(),t,2)}function W(n,t){return M(n.getHours()%12||12,t,2)}function V(n,t){return M(1+ht.count(pt(n),n),t,3)}function E(n,t){return M(n.getMilliseconds(),t,3)}function Q(n,t){return E(n,t)+\"000\"}function X(n,t){return M(n.getMonth()+1,t,2)}function q(n,t){return M(n.getMinutes(),t,2)}function J(n,t){return M(n.getSeconds(),t,2)}function B(n){var t=n.getDay();return 0===t?7:t}function R(n,t){return M(gt.count(pt(n),n),t,2)}function G(n,t){var e=n.getDay();return n=e>=4||0===e?vt(n):vt.ceil(n),M(vt.count(pt(n),n)+(4===pt(n).getDay()),t,2)}function K(n){return n.getDay()}function nn(n,t){return M(dt.count(pt(n),n),t,2)}function tn(n,t){return M(n.getFullYear()%100,t,2)}function en(n,t){return M(n.getFullYear()%1e4,t,4)}function rn(n){var t=n.getTimezoneOffset();return(t>0?\"-\":(t*=-1,\"+\"))+M(t/60|0,\"0\",2)+M(t%60,\"0\",2)}function un(n,t){return M(n.getUTCDate(),t,2)}function on(n,t){return M(n.getUTCHours(),t,2)}function an(n,t){return M(n.getUTCHours()%12||12,t,2)}function cn(n,t){return M(1+xt.count(Ut(n),n),t,3)}function fn(n,t){return M(n.getUTCMilliseconds(),t,3)}function ln(n,t){return fn(n,t)+\"000\"}function sn(n,t){return M(n.getUTCMonth()+1,t,2)}function hn(n,t){return M(n.getUTCMinutes(),t,2)}function gn(n,t){return M(n.getUTCSeconds(),t,2)}function dn(n){var t=n.getUTCDay();return 0===t?7:t}function vn(n,t){return M(wt.count(Ut(n),n),t,2)}function yn(n,t){var e=n.getUTCDay();return n=e>=4||0===e?_t(n):_t.ceil(n),M(_t.count(Ut(n),n)+(4===Ut(n).getUTCDay()),t,2)}function pn(n){return n.getUTCDay()}function Mn(n,t){return M(Tt.count(Ut(n),n),t,2)}function mn(n,t){return M(n.getUTCFullYear()%100,t,2)}function xn(n,t){return M(n.getUTCFullYear()%1e4,t,4)}function wn(){return\"+0000\"}function Tn(){return\"%\"}function _n(n){return+n}function Cn(n){return Math.floor(+n/1e3)}function Un(n,t){return(t-=n=+n)?function(e){return(e-n)/t}:jt(t)}function Dn(n,t){return t.domain(n.domain()).range(n.range()).interpolate(n.interpolate()).clamp(n.clamp())}function bn(n,t){function e(){return u=Math.min(a.length,c.length)>2?function(n,t,e,r){var u=Math.min(n.length,t.length)-1,i=new Array(u),o=new Array(u),a=-1;for(n[u]<n[0]&&(n=n.slice().reverse(),t=t.slice().reverse());++a<u;)i[a]=e(n[a],n[a+1]),o[a]=r(t[a],t[a+1]);return function(t){var e=In(n,t,1,u)-1;return o[e](i[e](t))}}:function(n,t,e,r){var u=n[0],i=n[1],o=t[0],a=t[1];return i<u?(u=e(i,u),o=r(a,o)):(u=e(u,i),o=r(o,a)),function(n){return o(u(n))}},i=o=null,r}function r(t){return(i||(i=u(a,c,l?function(n){return function(t,e){var r=n(t=+t,e=+e);return function(n){return n<=t?0:n>=e?1:r(n)}}}(n):n,f)))(+t)}var u,i,o,a=zt,c=zt,f=et,l=!1;return r.invert=function(n){return(o||(o=u(c,a,Un,l?function(n){return function(t,e){var r=n(t=+t,e=+e);return function(n){return n<=0?t:n>=1?e:r(n)}}}(t):t)))(+n)},r.domain=function(n){return arguments.length?(a=qn.call(n,Ot),e()):a.slice()},r.range=function(n){return arguments.length?(c=Jn.call(n),e()):c.slice()},r.rangeRound=function(n){return c=Jn.call(n),f=rt,e()},r.clamp=function(n){return arguments.length?(l=!!n,e()):l},r.interpolate=function(n){return arguments.length?(f=n,e()):f},e()}function Nn(n){return new Date(n)}function An(n){return n instanceof Date?+n:+new Date(+n)}function Fn(n,t,e,u,i,o,a,c,f){function l(t,e,u,i){if(null==t&&(t=10),\"number\"==typeof t){var o=Math.abs(u-e)/t,a=zn(function(n){return n[2]}).right(T,o);a===T.length?(i=r(e/Xt,u/Xt,t),t=n):a?(i=(a=T[o/T[a-1][2]<T[a][2]/o?a-1:a])[1],t=a[0]):(i=Math.max(r(e,u,t),1),t=c)}return null==i?t:t.every(i)}var s=bn(Un,Kn),h=s.invert,g=s.domain,d=f(\".%L\"),v=f(\":%S\"),y=f(\"%I:%M\"),p=f(\"%I %p\"),M=f(\"%a %d\"),m=f(\"%b %d\"),x=f(\"%B\"),w=f(\"%Y\"),T=[[a,1,Zt],[a,5,5*Zt],[a,15,15*Zt],[a,30,30*Zt],[o,1,Pt],[o,5,5*Pt],[o,15,15*Pt],[o,30,30*Pt],[i,1,Wt],[i,3,3*Wt],[i,6,6*Wt],[i,12,12*Wt],[u,1,Vt],[u,2,2*Vt],[e,1,Et],[t,1,Qt],[t,3,3*Qt],[n,1,Xt]];return s.invert=function(n){return new Date(h(n))},s.domain=function(n){return arguments.length?g(qn.call(n,An)):g().map(Nn)},s.ticks=function(n,t){var e,r=g(),u=r[0],i=r[r.length-1],o=i<u;return o&&(e=u,u=i,i=e),e=l(n,u,i,t),e=e?e.range(u,i+1):[],o?e.reverse():e},s.tickFormat=function(r,c){return null==c?function(r){return(a(r)<r?d:o(r)<r?v:i(r)<r?y:u(r)<r?p:t(r)<r?e(r)<r?M:m:n(r)<r?x:w)(r)}:f(c)},s.nice=function(n,t){var e=g();return(n=l(n,e[0],e[e.length-1],t))?g(It(e,n)):s},s.copy=function(){return Dn(s,Fn(n,t,e,u,i,o,a,c,f))},s}function Sn(n){return new Yn(n)}function Yn(n){if(!(t=Gt.exec(n)))throw new Error(\"invalid format: \"+n);var t,e=t[1]||\" \",r=t[2]||\">\",u=t[3]||\"-\",i=t[4]||\"\",o=!!t[5],a=t[6]&&+t[6],c=!!t[7],f=t[8]&&+t[8].slice(1),l=t[9]||\"\";\"n\"===l?(c=!0,l=\"g\"):Rt[l]||(l=\"\"),(o||\"0\"===e&&\"=\"===r)&&(o=!0,e=\"0\",r=\"=\"),this.fill=e,this.align=r,this.sign=u,this.symbol=i,this.zero=o,this.width=a,this.comma=c,this.precision=f,this.type=l}function Hn(){var n=bn(Un,Kn);return n.copy=function(){return Dn(n,Hn())},function(n){var t=n.domain;return n.ticks=function(n){var e=t();return En(e[0],e[e.length-1],null==n?10:n)},n.tickFormat=function(n,e){return ie(t(),n,e)},n.nice=function(r){null==r&&(r=10);var u,i=t(),o=0,a=i.length-1,c=i[o],f=i[a];return f<c&&(u=c,c=f,f=u,u=o,o=a,a=u),(u=e(c,f,r))>0?u=e(c=Math.floor(c/u)*u,f=Math.ceil(f/u)*u,r):u<0&&(u=e(c=Math.ceil(c*u)/u,f=Math.floor(f*u)/u,r)),u>0?(i[o]=Math.floor(c/u)*u,i[a]=Math.ceil(f/u)*u,t(i)):u<0&&(i[o]=Math.ceil(c*u)/u,i[a]=Math.floor(f*u)/u,t(i)),n},n}(n)}function kn(n,t,e,r){if(isNaN(t)||isNaN(e))return n;var u,i,o,a,c,f,l,s,h,g=n._root,d={data:r},v=n._x0,y=n._y0,p=n._x1,M=n._y1;if(!g)return n._root=d,n;for(;g.length;)if((f=t>=(i=(v+p)/2))?v=i:p=i,(l=e>=(o=(y+M)/2))?y=o:M=o,u=g,!(g=g[s=l<<1|f]))return u[s]=d,n;if(a=+n._x.call(null,g.data),c=+n._y.call(null,g.data),t===a&&e===c)return d.next=g,u?u[s]=d:n._root=d,n;do{u=u?u[s]=new Array(4):n._root=new Array(4),(f=t>=(i=(v+p)/2))?v=i:p=i,(l=e>=(o=(y+M)/2))?y=o:M=o}while((s=l<<1|f)==(h=(c>=o)<<1|a>=i));return u[h]=g,u[s]=d,n}function Ln(n,t,e){var r=new $n(null==t?function(n){return n[0]}:t,null==e?function(n){return n[1]}:e,NaN,NaN,NaN,NaN);return null==n?r:r.addAll(n)}function $n(n,t,e,r,u,i){this._x=n,this._y=t,this._x0=e,this._y0=r,this._x1=u,this._y1=i,this._root=void 0}function jn(n){for(var t={data:n.data},e=t;n=n.next;)e=e.next={data:n.data};return t}var On=function(n,t){return n<t?-1:n>t?1:n>=t?0:NaN},zn=function(n){return 1===n.length&&(n=function(n){return function(t,e){return On(n(t),e)}}(n)),{left:function(t,e,r,u){for(null==r&&(r=0),null==u&&(u=t.length);r<u;){var i=r+u>>>1;n(t[i],e)<0?r=i+1:u=i}return r},right:function(t,e,r,u){for(null==r&&(r=0),null==u&&(u=t.length);r<u;){var i=r+u>>>1;n(t[i],e)>0?u=i:r=i+1}return r}}},In=zn(On).right,Zn=function(n,t,e){n=+n,t=+t,e=(u=arguments.length)<2?(t=n,n=0,1):u<3?1:+e;for(var r=-1,u=0|Math.max(0,Math.ceil((t-n)/e)),i=new Array(u);++r<u;)i[r]=n+r*e;return i},Pn=Math.sqrt(50),Wn=Math.sqrt(10),Vn=Math.sqrt(2),En=function(n,t,r){var u,i,o,a,c=-1;if(t=+t,n=+n,r=+r,n===t&&r>0)return[n];if((u=t<n)&&(i=n,n=t,t=i),0===(a=e(n,t,r))||!isFinite(a))return[];if(a>0)for(n=Math.ceil(n/a),t=Math.floor(t/a),o=new Array(i=Math.ceil(t-n+1));++c<i;)o[c]=(n+c)*a;else for(n=Math.floor(n*a),t=Math.ceil(t*a),o=new Array(i=Math.ceil(n-t+1));++c<i;)o[c]=(n-c)/a;return u&&o.reverse(),o};u.prototype=i.prototype={constructor:u,has:function(n){return\"$\"+n in this},get:function(n){return this[\"$\"+n]},set:function(n,t){return this[\"$\"+n]=t,this},remove:function(n){var t=\"$\"+n;return t in this&&delete this[t]},clear:function(){for(var n in this)\"$\"===n[0]&&delete this[n]},keys:function(){var n=[];for(var t in this)\"$\"===t[0]&&n.push(t.slice(1));return n},values:function(){var n=[];for(var t in this)\"$\"===t[0]&&n.push(this[t]);return n},entries:function(){var n=[];for(var t in this)\"$\"===t[0]&&n.push({key:t.slice(1),value:this[t]});return n},size:function(){var n=0;for(var t in this)\"$\"===t[0]&&++n;return n},empty:function(){for(var n in this)if(\"$\"===n[0])return!1;return!0},each:function(n){for(var t in this)\"$\"===t[0]&&n(this[t],t.slice(1),this)}};var Qn=i.prototype;o.prototype=function(n,t){var e=new o;if(n instanceof o)n.each(function(n){e.add(n)});else if(n){var r=-1,u=n.length;if(null==t)for(;++r<u;)e.add(n[r]);else for(;++r<u;)e.add(t(n[r],r,n))}return e}.prototype={constructor:o,has:Qn.has,add:function(n){return n+=\"\",this[\"$\"+n]=n,this},remove:Qn.remove,clear:Qn.clear,values:Qn.keys,size:Qn.size,empty:Qn.empty,each:Qn.each};var Xn=Array.prototype,qn=Xn.map,Jn=Xn.slice,Bn={name:\"implicit\"},Rn=function(n){return function(){return n}},Gn=function n(e){function r(n,e){var r=u((n=t.rgb(n)).r,(e=t.rgb(e)).r),i=u(n.g,e.g),o=u(n.b,e.b),a=s(n.opacity,e.opacity);return function(t){return n.r=r(t),n.g=i(t),n.b=o(t),n.opacity=a(t),n+\"\"}}var u=l(e);return r.gamma=n,r}(1),Kn=function(n,t){return n=+n,t-=n,function(e){return n+t*e}},nt=/[-+]?(?:\\d+\\.?\\d*|\\.?\\d+)(?:[eE][-+]?\\d+)?/g,tt=new RegExp(nt.source,\"g\"),et=function(n,e){var r,u=typeof e;return null==e||\"boolean\"===u?Rn(e):(\"number\"===u?Kn:\"string\"===u?(r=t.color(e))?(e=r,Gn):function(n,t){var e,r,u,i=nt.lastIndex=tt.lastIndex=0,o=-1,a=[],c=[];for(n+=\"\",t+=\"\";(e=nt.exec(n))&&(r=tt.exec(t));)(u=r.index)>i&&(u=t.slice(i,u),a[o]?a[o]+=u:a[++o]=u),(e=e[0])===(r=r[0])?a[o]?a[o]+=r:a[++o]=r:(a[++o]=null,c.push({i:o,x:Kn(e,r)})),i=tt.lastIndex;return i<t.length&&(u=t.slice(i),a[o]?a[o]+=u:a[++o]=u),a.length<2?c[0]?function(n){return function(t){return n(t)+\"\"}}(c[0].x):function(n){return function(){return n}}(t):(t=c.length,function(n){for(var e,r=0;r<t;++r)a[(e=c[r]).i]=e.x(n);return a.join(\"\")})}:e instanceof t.color?Gn:e instanceof Date?function(n,t){var e=new Date;return n=+n,t-=n,function(r){return e.setTime(n+t*r),e}}:Array.isArray(e)?function(n,t){var e,r=t?t.length:0,u=n?Math.min(r,n.length):0,i=new Array(u),o=new Array(r);for(e=0;e<u;++e)i[e]=et(n[e],t[e]);for(;e<r;++e)o[e]=t[e];return function(n){for(e=0;e<u;++e)o[e]=i[e](n);return o}}:\"function\"!=typeof e.valueOf&&\"function\"!=typeof e.toString||isNaN(e)?function(n,t){var e,r={},u={};null!==n&&\"object\"==typeof n||(n={}),null!==t&&\"object\"==typeof t||(t={});for(e in t)e in n?r[e]=et(n[e],t[e]):u[e]=t[e];return function(n){for(e in r)u[e]=r[e](n);return u}}:Kn)(n,e)},rt=function(n,t){return n=+n,t-=n,function(e){return Math.round(n+t*e)}},ut=(Math.PI,Math.SQRT2,new Date),it=new Date,ot=h(function(){},function(n,t){n.setTime(+n+t)},function(n,t){return t-n});ot.every=function(n){return n=Math.floor(n),isFinite(n)&&n>0?n>1?h(function(t){t.setTime(Math.floor(t/n)*n)},function(t,e){t.setTime(+t+e*n)},function(t,e){return(e-t)/n}):ot:null};var at=6e4,ct=6048e5,ft=h(function(n){n.setTime(1e3*Math.floor(n/1e3))},function(n,t){n.setTime(+n+1e3*t)},function(n,t){return(t-n)/1e3},function(n){return n.getUTCSeconds()}),lt=h(function(n){n.setTime(Math.floor(n/at)*at)},function(n,t){n.setTime(+n+t*at)},function(n,t){return(t-n)/at},function(n){return n.getMinutes()}),st=h(function(n){var t=n.getTimezoneOffset()*at%36e5;t<0&&(t+=36e5),n.setTime(36e5*Math.floor((+n-t)/36e5)+t)},function(n,t){n.setTime(+n+36e5*t)},function(n,t){return(t-n)/36e5},function(n){return n.getHours()}),ht=h(function(n){n.setHours(0,0,0,0)},function(n,t){n.setDate(n.getDate()+t)},function(n,t){return(t-n-(t.getTimezoneOffset()-n.getTimezoneOffset())*at)/864e5},function(n){return n.getDate()-1}),gt=g(0),dt=g(1),vt=(g(2),g(3),g(4)),yt=(g(5),g(6),h(function(n){n.setDate(1),n.setHours(0,0,0,0)},function(n,t){n.setMonth(n.getMonth()+t)},function(n,t){return t.getMonth()-n.getMonth()+12*(t.getFullYear()-n.getFullYear())},function(n){return n.getMonth()})),pt=h(function(n){n.setMonth(0,1),n.setHours(0,0,0,0)},function(n,t){n.setFullYear(n.getFullYear()+t)},function(n,t){return t.getFullYear()-n.getFullYear()},function(n){return n.getFullYear()});pt.every=function(n){return isFinite(n=Math.floor(n))&&n>0?h(function(t){t.setFullYear(Math.floor(t.getFullYear()/n)*n),t.setMonth(0,1),t.setHours(0,0,0,0)},function(t,e){t.setFullYear(t.getFullYear()+e*n)}):null};var Mt=h(function(n){n.setUTCSeconds(0,0)},function(n,t){n.setTime(+n+t*at)},function(n,t){return(t-n)/at},function(n){return n.getUTCMinutes()}),mt=h(function(n){n.setUTCMinutes(0,0,0)},function(n,t){n.setTime(+n+36e5*t)},function(n,t){return(t-n)/36e5},function(n){return n.getUTCHours()}),xt=h(function(n){n.setUTCHours(0,0,0,0)},function(n,t){n.setUTCDate(n.getUTCDate()+t)},function(n,t){return(t-n)/864e5},function(n){return n.getUTCDate()-1}),wt=d(0),Tt=d(1),_t=(d(2),d(3),d(4)),Ct=(d(5),d(6),h(function(n){n.setUTCDate(1),n.setUTCHours(0,0,0,0)},function(n,t){n.setUTCMonth(n.getUTCMonth()+t)},function(n,t){return t.getUTCMonth()-n.getUTCMonth()+12*(t.getUTCFullYear()-n.getUTCFullYear())},function(n){return n.getUTCMonth()})),Ut=h(function(n){n.setUTCMonth(0,1),n.setUTCHours(0,0,0,0)},function(n,t){n.setUTCFullYear(n.getUTCFullYear()+t)},function(n,t){return t.getUTCFullYear()-n.getUTCFullYear()},function(n){return n.getUTCFullYear()});Ut.every=function(n){return isFinite(n=Math.floor(n))&&n>0?h(function(t){t.setUTCFullYear(Math.floor(t.getUTCFullYear()/n)*n),t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0)},function(t,e){t.setUTCFullYear(t.getUTCFullYear()+e*n)}):null};var Dt,bt,Nt,At,Ft,St={\"-\":\"\",_:\" \",0:\"0\"},Yt=/^\\s*\\d+/,Ht=/^%/,kt=/[\\\\^$*+?|[\\]().{}]/g;!function(n){Dt=function(n){function t(n,t){return function(e){var r,u,i,o=[],a=-1,c=0,f=n.length;for(e instanceof Date||(e=new Date(+e));++a<f;)37===n.charCodeAt(a)&&(o.push(n.slice(c,a)),null!=(u=St[r=n.charAt(++a)])?r=n.charAt(++a):u=\"e\"===r?\" \":\"0\",(i=t[r])&&(r=i(e,u)),o.push(r),c=a+1);return o.push(n.slice(c,a)),o.join(\"\")}}function e(n,t){return function(e){var u,i,o=p(1900);if(r(o,n,e+=\"\",0)!=e.length)return null;if(\"Q\"in o)return new Date(o.Q);if(\"p\"in o&&(o.H=o.H%12+12*o.p),\"V\"in o){if(o.V<1||o.V>53)return null;\"w\"in o||(o.w=1),\"Z\"in o?(u=(i=(u=y(p(o.y))).getUTCDay())>4||0===i?Tt.ceil(u):Tt(u),u=xt.offset(u,7*(o.V-1)),o.y=u.getUTCFullYear(),o.m=u.getUTCMonth(),o.d=u.getUTCDate()+(o.w+6)%7):(u=(i=(u=t(p(o.y))).getDay())>4||0===i?dt.ceil(u):dt(u),u=ht.offset(u,7*(o.V-1)),o.y=u.getFullYear(),o.m=u.getMonth(),o.d=u.getDate()+(o.w+6)%7)}else(\"W\"in o||\"U\"in o)&&(\"w\"in o||(o.w=\"u\"in o?o.u%7:\"W\"in o?1:0),i=\"Z\"in o?y(p(o.y)).getUTCDay():t(p(o.y)).getDay(),o.m=0,o.d=\"W\"in o?(o.w+6)%7+7*o.W-(i+5)%7:o.w+7*o.U-(i+6)%7);return\"Z\"in o?(o.H+=o.Z/100|0,o.M+=o.Z%100,y(o)):t(o)}}function r(n,t,e,r){for(var u,i,o=0,a=t.length,c=e.length;o<a;){if(r>=c)return-1;if(37===(u=t.charCodeAt(o++))){if(u=t.charAt(o++),!(i=Yn[u in St?t.charAt(o++):u])||(r=i(n,e,r))<0)return-1}else if(u!=e.charCodeAt(r++))return-1}return r}var u=n.dateTime,i=n.date,o=n.time,a=n.periods,c=n.days,f=n.shortDays,l=n.months,s=n.shortMonths,h=x(a),g=w(a),d=x(c),M=w(c),m=x(f),Un=w(f),Dn=x(l),bn=w(l),Nn=x(s),An=w(s),Fn={a:function(n){return f[n.getDay()]},A:function(n){return c[n.getDay()]},b:function(n){return s[n.getMonth()]},B:function(n){return l[n.getMonth()]},c:null,d:Z,e:Z,f:Q,H:P,I:W,j:V,L:E,m:X,M:q,p:function(n){return a[+(n.getHours()>=12)]},Q:_n,s:Cn,S:J,u:B,U:R,V:G,w:K,W:nn,x:null,X:null,y:tn,Y:en,Z:rn,\"%\":Tn},Sn={a:function(n){return f[n.getUTCDay()]},A:function(n){return c[n.getUTCDay()]},b:function(n){return s[n.getUTCMonth()]},B:function(n){return l[n.getUTCMonth()]},c:null,d:un,e:un,f:ln,H:on,I:an,j:cn,L:fn,m:sn,M:hn,p:function(n){return a[+(n.getUTCHours()>=12)]},Q:_n,s:Cn,S:gn,u:dn,U:vn,V:yn,w:pn,W:Mn,x:null,X:null,y:mn,Y:xn,Z:wn,\"%\":Tn},Yn={a:function(n,t,e){var r=m.exec(t.slice(e));return r?(n.w=Un[r[0].toLowerCase()],e+r[0].length):-1},A:function(n,t,e){var r=d.exec(t.slice(e));return r?(n.w=M[r[0].toLowerCase()],e+r[0].length):-1},b:function(n,t,e){var r=Nn.exec(t.slice(e));return r?(n.m=An[r[0].toLowerCase()],e+r[0].length):-1},B:function(n,t,e){var r=Dn.exec(t.slice(e));return r?(n.m=bn[r[0].toLowerCase()],e+r[0].length):-1},c:function(n,t,e){return r(n,u,t,e)},d:S,e:S,f:j,H:H,I:H,j:Y,L:$,m:F,M:k,p:function(n,t,e){var r=h.exec(t.slice(e));return r?(n.p=g[r[0].toLowerCase()],e+r[0].length):-1},Q:z,s:I,S:L,u:_,U:C,V:U,w:T,W:D,x:function(n,t,e){return r(n,i,t,e)},X:function(n,t,e){return r(n,o,t,e)},y:N,Y:b,Z:A,\"%\":O};return Fn.x=t(i,Fn),Fn.X=t(o,Fn),Fn.c=t(u,Fn),Sn.x=t(i,Sn),Sn.X=t(o,Sn),Sn.c=t(u,Sn),{format:function(n){var e=t(n+=\"\",Fn);return e.toString=function(){return n},e},parse:function(n){var t=e(n+=\"\",v);return t.toString=function(){return n},t},utcFormat:function(n){var e=t(n+=\"\",Sn);return e.toString=function(){return n},e},utcParse:function(n){var t=e(n,y);return t.toString=function(){return n},t}}}(n),bt=Dt.format,Nt=Dt.parse,At=Dt.utcFormat,Ft=Dt.utcParse}({dateTime:\"%x, %X\",date:\"%-m/%-d/%Y\",time:\"%-I:%M:%S %p\",periods:[\"AM\",\"PM\"],days:[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"],shortDays:[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"],months:[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],shortMonths:[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"]});var Lt,$t=\"%Y-%m-%dT%H:%M:%S.%LZ\",jt=(Date.prototype.toISOString||At($t),+new Date(\"2000-01-01T00:00:00.000Z\")||Ft($t),function(n){return function(){return n}}),Ot=function(n){return+n},zt=[0,1],It=function(n,t){var e,r=0,u=(n=n.slice()).length-1,i=n[r],o=n[u];return o<i&&(e=r,r=u,u=e,e=i,i=o,o=e),n[r]=t.floor(i),n[u]=t.ceil(o),n},Zt=1e3,Pt=60*Zt,Wt=60*Pt,Vt=24*Wt,Et=7*Vt,Qt=30*Vt,Xt=365*Vt,qt=function(n,t){if((e=(n=t?n.toExponential(t-1):n.toExponential()).indexOf(\"e\"))<0)return null;var e,r=n.slice(0,e);return[r.length>1?r[0]+r.slice(2):r,+n.slice(e+1)]},Jt=function(n){return(n=qt(Math.abs(n)))?n[1]:NaN},Bt=function(n,t){var e=qt(n,t);if(!e)return n+\"\";var r=e[0],u=e[1];return u<0?\"0.\"+new Array(-u).join(\"0\")+r:r.length>u+1?r.slice(0,u+1)+\".\"+r.slice(u+1):r+new Array(u-r.length+2).join(\"0\")},Rt={\"\":function(n,t){n:for(var e,r=(n=n.toPrecision(t)).length,u=1,i=-1;u<r;++u)switch(n[u]){case\".\":i=e=u;break;case\"0\":0===i&&(i=u),e=u;break;case\"e\":break n;default:i>0&&(i=0)}return i>0?n.slice(0,i)+n.slice(e+1):n},\"%\":function(n,t){return(100*n).toFixed(t)},b:function(n){return Math.round(n).toString(2)},c:function(n){return n+\"\"},d:function(n){return Math.round(n).toString(10)},e:function(n,t){return n.toExponential(t)},f:function(n,t){return n.toFixed(t)},g:function(n,t){return n.toPrecision(t)},o:function(n){return Math.round(n).toString(8)},p:function(n,t){return Bt(100*n,t)},r:Bt,s:function(n,t){var e=qt(n,t);if(!e)return n+\"\";var r=e[0],u=e[1],i=u-(Lt=3*Math.max(-8,Math.min(8,Math.floor(u/3))))+1,o=r.length;return i===o?r:i>o?r+new Array(i-o+1).join(\"0\"):i>0?r.slice(0,i)+\".\"+r.slice(i):\"0.\"+new Array(1-i).join(\"0\")+qt(n,Math.max(0,t+i-1))[0]},X:function(n){return Math.round(n).toString(16).toUpperCase()},x:function(n){return Math.round(n).toString(16)}},Gt=/^(?:(.)?([<>=^]))?([+\\-\\( ])?([$#])?(0)?(\\d+)?(,)?(\\.\\d+)?([a-z%])?$/i;Sn.prototype=Yn.prototype,Yn.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?\"0\":\"\")+(null==this.width?\"\":Math.max(1,0|this.width))+(this.comma?\",\":\"\")+(null==this.precision?\"\":\".\"+Math.max(0,0|this.precision))+this.type};var Kt,ne,te,ee=function(n){return n},re=[\"y\",\"z\",\"a\",\"f\",\"p\",\"n\",\"Âµ\",\"m\",\"\",\"k\",\"M\",\"G\",\"T\",\"P\",\"E\",\"Z\",\"Y\"],ue=function(n){function t(n){function t(n){var t,r,o,l=y,x=p;if(\"c\"===v)x=M(n)+x,n=\"\";else{var w=(n=+n)<0;if(n=M(Math.abs(n),d),w&&0==+n&&(w=!1),l=(w?\"(\"===f?f:\"-\":\"-\"===f||\"(\"===f?\"\":f)+l,x=x+(\"s\"===v?re[8+Lt/3]:\"\")+(w&&\"(\"===f?\")\":\"\"),m)for(t=-1,r=n.length;++t<r;)if(48>(o=n.charCodeAt(t))||o>57){x=(46===o?u+n.slice(t+1):n.slice(t))+x,n=n.slice(0,t);break}}g&&!s&&(n=e(n,1/0));var T=l.length+n.length+x.length,_=T<h?new Array(h-T+1).join(a):\"\";switch(g&&s&&(n=e(_+n,_.length?h-x.length:1/0),_=\"\"),c){case\"<\":n=l+n+x+_;break;case\"=\":n=l+_+n+x;break;case\"^\":n=_.slice(0,T=_.length>>1)+l+n+x+_.slice(T);break;default:n=_+l+n+x}return i(n)}var a=(n=Sn(n)).fill,c=n.align,f=n.sign,l=n.symbol,s=n.zero,h=n.width,g=n.comma,d=n.precision,v=n.type,y=\"$\"===l?r[0]:\"#\"===l&&/[boxX]/.test(v)?\"0\"+v.toLowerCase():\"\",p=\"$\"===l?r[1]:/[%p]/.test(v)?o:\"\",M=Rt[v],m=!v||/[defgprs%]/.test(v);return d=null==d?v?6:12:/[gprs]/.test(v)?Math.max(1,Math.min(21,d)):Math.max(0,Math.min(20,d)),t.toString=function(){return n+\"\"},t}var e=n.grouping&&n.thousands?function(n,t){return function(e,r){for(var u=e.length,i=[],o=0,a=n[0],c=0;u>0&&a>0&&(c+a+1>r&&(a=Math.max(1,r-c)),i.push(e.substring(u-=a,u+a)),!((c+=a+1)>r));)a=n[o=(o+1)%n.length];return i.reverse().join(t)}}(n.grouping,n.thousands):ee,r=n.currency,u=n.decimal,i=n.numerals?function(n){return function(t){return t.replace(/[0-9]/g,function(t){return n[+t]})}}(n.numerals):ee,o=n.percent||\"%\";return{format:t,formatPrefix:function(n,e){var r=t((n=Sn(n),n.type=\"f\",n)),u=3*Math.max(-8,Math.min(8,Math.floor(Jt(e)/3))),i=Math.pow(10,-u),o=re[8+u/3];return function(n){return r(i*n)+o}}}};!function(n){Kt=ue(n),ne=Kt.format,te=Kt.formatPrefix}({decimal:\".\",thousands:\",\",grouping:[3],currency:[\"$\",\"\"]});var ie=function(n,t,e){var u,i=n[0],o=n[n.length-1],a=r(i,o,null==t?10:t);switch((e=Sn(null==e?\",f\":e)).type){case\"s\":var c=Math.max(Math.abs(i),Math.abs(o));return null!=e.precision||isNaN(u=function(n,t){return Math.max(0,3*Math.max(-8,Math.min(8,Math.floor(Jt(t)/3)))-Jt(Math.abs(n)))}(a,c))||(e.precision=u),te(e,c);case\"\":case\"e\":case\"g\":case\"p\":case\"r\":null!=e.precision||isNaN(u=function(n,t){return n=Math.abs(n),t=Math.abs(t)-n,Math.max(0,Jt(t)-Jt(n))+1}(a,Math.max(Math.abs(i),Math.abs(o))))||(e.precision=u-(\"e\"===e.type));break;case\"f\":case\"%\":null!=e.precision||isNaN(u=function(n){return Math.max(0,-Jt(Math.abs(n)))}(a))||(e.precision=u-2*(\"%\"===e.type))}return ne(e)},oe=function(n,t){return n<t?-1:n>t?1:n>=t?0:NaN},ae=(function(n){1===n.length&&(n=function(n){return function(t,e){return oe(n(t),e)}}(n))}(oe),function(n,t,e,r,u){this.node=n,this.x0=t,this.y0=e,this.x1=r,this.y1=u}),ce=Ln.prototype=$n.prototype;ce.copy=function(){var n,t,e=new $n(this._x,this._y,this._x0,this._y0,this._x1,this._y1),r=this._root;if(!r)return e;if(!r.length)return e._root=jn(r),e;for(n=[{source:r,target:e._root=new Array(4)}];r=n.pop();)for(var u=0;u<4;++u)(t=r.source[u])&&(t.length?n.push({source:t,target:r.target[u]=new Array(4)}):r.target[u]=jn(t));return e},ce.add=function(n){var t=+this._x.call(null,n),e=+this._y.call(null,n);return kn(this.cover(t,e),t,e,n)},ce.addAll=function(n){var t,e,r,u,i=n.length,o=new Array(i),a=new Array(i),c=1/0,f=1/0,l=-1/0,s=-1/0;for(e=0;e<i;++e)isNaN(r=+this._x.call(null,t=n[e]))||isNaN(u=+this._y.call(null,t))||(o[e]=r,a[e]=u,r<c&&(c=r),r>l&&(l=r),u<f&&(f=u),u>s&&(s=u));for(l<c&&(c=this._x0,l=this._x1),s<f&&(f=this._y0,s=this._y1),this.cover(c,f).cover(l,s),e=0;e<i;++e)kn(this,o[e],a[e],n[e]);return this},ce.cover=function(n,t){if(isNaN(n=+n)||isNaN(t=+t))return this;var e=this._x0,r=this._y0,u=this._x1,i=this._y1;if(isNaN(e))u=(e=Math.floor(n))+1,i=(r=Math.floor(t))+1;else{if(!(e>n||n>u||r>t||t>i))return this;var o,a,c=u-e,f=this._root;switch(a=(t<(r+i)/2)<<1|n<(e+u)/2){case 0:do{o=new Array(4),o[a]=f,f=o}while(c*=2,u=e+c,i=r+c,n>u||t>i);break;case 1:do{o=new Array(4),o[a]=f,f=o}while(c*=2,e=u-c,i=r+c,e>n||t>i);break;case 2:do{o=new Array(4),o[a]=f,f=o}while(c*=2,u=e+c,r=i-c,n>u||r>t);break;case 3:do{o=new Array(4),o[a]=f,f=o}while(c*=2,e=u-c,r=i-c,e>n||r>t)}this._root&&this._root.length&&(this._root=f)}return this._x0=e,this._y0=r,this._x1=u,this._y1=i,this},ce.data=function(){var n=[];return this.visit(function(t){if(!t.length)do{n.push(t.data)}while(t=t.next)}),n},ce.extent=function(n){return arguments.length?this.cover(+n[0][0],+n[0][1]).cover(+n[1][0],+n[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]},ce.find=function(n,t,e){var r,u,i,o,a,c,f,l=this._x0,s=this._y0,h=this._x1,g=this._y1,d=[],v=this._root;for(v&&d.push(new ae(v,l,s,h,g)),null==e?e=1/0:(l=n-e,s=t-e,h=n+e,g=t+e,e*=e);c=d.pop();)if(!(!(v=c.node)||(u=c.x0)>h||(i=c.y0)>g||(o=c.x1)<l||(a=c.y1)<s))if(v.length){var y=(u+o)/2,p=(i+a)/2;d.push(new ae(v[3],y,p,o,a),new ae(v[2],u,p,y,a),new ae(v[1],y,i,o,p),new ae(v[0],u,i,y,p)),(f=(t>=p)<<1|n>=y)&&(c=d[d.length-1],d[d.length-1]=d[d.length-1-f],d[d.length-1-f]=c)}else{var M=n-+this._x.call(null,v.data),m=t-+this._y.call(null,v.data),x=M*M+m*m;if(x<e){var w=Math.sqrt(e=x);l=n-w,s=t-w,h=n+w,g=t+w,r=v.data}}return r},ce.remove=function(n){if(isNaN(i=+this._x.call(null,n))||isNaN(o=+this._y.call(null,n)))return this;var t,e,r,u,i,o,a,c,f,l,s,h,g=this._root,d=this._x0,v=this._y0,y=this._x1,p=this._y1;if(!g)return this;if(g.length)for(;;){if((f=i>=(a=(d+y)/2))?d=a:y=a,(l=o>=(c=(v+p)/2))?v=c:p=c,t=g,!(g=g[s=l<<1|f]))return this;if(!g.length)break;(t[s+1&3]||t[s+2&3]||t[s+3&3])&&(e=t,h=s)}for(;g.data!==n;)if(r=g,!(g=g.next))return this;return(u=g.next)&&delete g.next,r?(u?r.next=u:delete r.next,this):t?(u?t[s]=u:delete t[s],(g=t[0]||t[1]||t[2]||t[3])&&g===(t[3]||t[2]||t[1]||t[0])&&!g.length&&(e?e[h]=g:this._root=g),this):(this._root=u,this)},ce.removeAll=function(n){for(var t=0,e=n.length;t<e;++t)this.remove(n[t]);return this},ce.root=function(){return this._root},ce.size=function(){var n=0;return this.visit(function(t){if(!t.length)do{++n}while(t=t.next)}),n},ce.visit=function(n){var t,e,r,u,i,o,a=[],c=this._root;for(c&&a.push(new ae(c,this._x0,this._y0,this._x1,this._y1));t=a.pop();)if(!n(c=t.node,r=t.x0,u=t.y0,i=t.x1,o=t.y1)&&c.length){var f=(r+i)/2,l=(u+o)/2;(e=c[3])&&a.push(new ae(e,f,l,i,o)),(e=c[2])&&a.push(new ae(e,r,l,f,o)),(e=c[1])&&a.push(new ae(e,f,u,i,l)),(e=c[0])&&a.push(new ae(e,r,u,f,l))}return this},ce.visitAfter=function(n){var t,e=[],r=[];for(this._root&&e.push(new ae(this._root,this._x0,this._y0,this._x1,this._y1));t=e.pop();){var u=t.node;if(u.length){var i,o=t.x0,a=t.y0,c=t.x1,f=t.y1,l=(o+c)/2,s=(a+f)/2;(i=u[0])&&e.push(new ae(i,o,a,l,s)),(i=u[1])&&e.push(new ae(i,l,a,c,s)),(i=u[2])&&e.push(new ae(i,o,s,l,f)),(i=u[3])&&e.push(new ae(i,l,s,c,f))}r.push(t)}for(;t=r.pop();)n(t.node,t.x0,t.y0,t.x1,t.y1);return this},ce.x=function(n){return arguments.length?(this._x=n,this):this._x},ce.y=function(n){return arguments.length?(this._y=n,this):this._y},n.scaleBand=c,n.scalePoint=function(){return f(c().paddingInner(1))},n.scaleTime=function(){return Fn(pt,yt,gt,ht,st,lt,ft,ot,bt).domain([new Date(2e3,0,1),new Date(2e3,0,2)])},n.scaleUtc=function(){return Fn(Ut,Ct,wt,xt,mt,Mt,ft,ot,At).domain([Date.UTC(2e3,0,1),Date.UTC(2e3,0,2)])},n.scaleLinear=Hn,n.extent=function(n,t){var e,r,u,i=n.length,o=-1;if(null==t){for(;++o<i;)if(null!=(e=n[o])&&e>=e)for(r=u=e;++o<i;)null!=(e=n[o])&&(r>e&&(r=e),u<e&&(u=e))}else for(;++o<i;)if(null!=(e=t(n[o],o,n))&&e>=e)for(r=u=e;++o<i;)null!=(e=t(n[o],o,n))&&(r>e&&(r=e),u<e&&(u=e));return[r,u]},n.polygonContains=function(n,t){for(var e,r,u=n.length,i=n[u-1],o=t[0],a=t[1],c=i[0],f=i[1],l=!1,s=0;s<u;++s)e=(i=n[s])[0],(r=i[1])>a!=f>a&&o<(c-e)*(a-r)/(f-r)+e&&(l=!l),c=e,f=r;return l},n.quadtree=Ln,Object.defineProperty(n,\"__esModule\",{value:!0})});var extentCalc={};extentCalc._defaultScaleValue={x:[Infinity,-Infinity],y:[Infinity,-Infinity]};extentCalc.determineExtents=function determineExtents(data){var xOrd=this.xAxisType===\"ordinal\"||this.xAxisType===\"scaleBand\",yOrd=this.yAxisType===\"ordinal\"||this.yAxisType===\"scaleBand\",xTime=this.xAxisType===\"time\"||this.xAxisType===\"timeLocal\",doX=xTime?false:true,doY=true,keys=Object.keys(this.completeSeriesConfig),extents={x:[],y:[]};extents.x=this._checkForExtents(xOrd,this.chartExtents,this.dataExtents,\"x\");extents.y=this.axes&&this.axes.length?this._calcMultiAxisExtents(data):this._checkForExtents(yOrd,this.chartExtents,this.dataExtents,\"y\");if(extents.x.length>0&&extents.x[0]!==Infinity&&extents.x[1]!==-Infinity){xTime=false;doX=false}if(!Array.isArray(extents.y)||extents.y.length>0&&extents.y[0]!==Infinity&&extents.y[1]!==-Infinity){doY=false}if(data.length===0){xTime=false;doX=false;doY=false}if(doX||doY||xTime){this._findMinMax(data,doX,doY,xOrd,yOrd,xTime,extents,keys)}if(extents.x[0]===Infinity){extents.x[0]=0}if(extents.x[1]===-Infinity){extents.x[1]=1}if(Array.isArray(extents.y)&&extents.y[0]===Infinity){extents.y[0]=0}if(Array.isArray(extents.y)&&extents.y[1]===-Infinity){extents.y[1]=1}if(extents.x[1]===extents.x[0]){extents.x[0]-=.5;extents.x[1]+=.5}if(Array.isArray(extents.y)){if(extents.y[1]===extents.y[0]){extents.y[0]-=.5;extents.y[1]+=.5}}else{var yKeys=Object.keys(extents.y);for(var i=0;i<yKeys.length;i++){if(extents.y[yKeys[i]][0]===extents.y[yKeys[i]][1]){extents.y[yKeys[i]][0]-=.5;extents.y[yKeys[i]][1]+=.5}}}return extents}.bind(extentCalc);extentCalc._checkForExtents=function _checkForExtents(isOrd,chartExtents,dataExtents,axis){var exts=[];if(isOrd){if(dataExtents&&dataExtents[axis]){exts=JSON.parse(JSON.stringify(dataExtents[axis]))}if(chartExtents&&chartExtents[axis]){exts=JSON.parse(JSON.stringify(chartExtents[axis]))}}else{var fromChartExtents=false;exts=this._checkChartExtents(chartExtents,axis);fromChartExtents=exts.length===2?true:false;exts=this._checkDataExtents(dataExtents,chartExtents,axis,fromChartExtents,exts);if(exts.length<2){exts=[this._defaultScaleValue[axis][0],this._defaultScaleValue[axis][1]]}}return exts}.bind(extentCalc);extentCalc._checkChartExtents=function _checkChartExtents(cExts,axis){var exts=[];if(cExts&&cExts[axis]&&cExts[axis].length===2){exts[0]=cExts[axis][0]===\"dynamic\"?Infinity:cExts[axis][0];exts[1]=cExts[axis][1]===\"dynamic\"?-Infinity:cExts[axis][1]}return exts}.bind(extentCalc);extentCalc._checkDataExtents=function _checkDataExtents(dExts,cExts,axis,bool,exts){var result=exts||[];if(dExts&&dExts[axis]&&dExts[axis].length===2){if(bool){result[0]=cExts[axis][0]===\"dynamic\"?dExts[axis][0]:cExts[axis][0];result[1]=cExts[axis][1]===\"dynamic\"?dExts[axis][1]:cExts[axis][1]}else{result[0]=Math.min(dExts[axis][0],this._defaultScaleValue[axis][0]);result[1]=Math.max(dExts[axis][1],this._defaultScaleValue[axis][1])}}return result}.bind(extentCalc);extentCalc._findMinMax=function _findMinMax(data,doX,doY,ordX,ordY,timeX,result,keys){var xVal,yVal,dLen=data.length,x=this.completeSeriesConfig[keys[0]].x,y=this.completeSeriesConfig[keys[0]].y,doX0=!ordX&&result.x[0]===Infinity?true:false,doX1=!ordX&&result.x[1]===-Infinity?true:false,doY0=!ordY&&result.y[0]===Infinity?true:false,doY1=!ordY&&result.y[1]===-Infinity?true:false;if(timeX){this._findTimeMM(result,data,dLen,x,doX0,doX1)}if(doX||doY){for(var i=0;i<dLen;i++){xVal=this._getDataExtents(data[i],keys,\"x\");yVal=this._getDataExtents(data[i],keys,\"y\");if(doX){this._processDataValues(ordX,result,data,\"x\",x,i,doX0,doX1,xVal[0],xVal[1])}if(doY){this._processDataValues(ordY,result,data,\"y\",y,i,doY0,doY1,yVal[0],yVal[1])}}}}.bind(extentCalc);extentCalc._getDataExtents=function _getDataExtents(d,keysArr,axis){var a=[];for(var i=0;i<keysArr.length;i++){var key=keysArr[i],val;if(!this.mutedSeries[keysArr[i]]){val=d[this.completeSeriesConfig[key][axis]];if(val||val===0){a.push(val)}}}return[Math.min.apply(null,a),Math.max.apply(null,a)]}.bind(extentCalc);extentCalc._findTimeMM=function _findTimeMM(result,d,l,x,doMin,doMax){if(doMin){this._setMin(result.x,d[0][x])}if(doMax){this._setMax(result.x,d[l-1][x])}}.bind(extentCalc);extentCalc._setMin=function _setMin(r,d){if(d===null){return}if(isNaN(r[0])||r[0]>d){r[0]=d}}.bind(extentCalc);extentCalc._setMax=function _setMax(r,d){if(d===null){return}if(isNaN(r[1])||r[1]<d){r[1]=d}}.bind(extentCalc);extentCalc._processDataValues=function _processDataValues(isOrd,r,d,axis,key,i,doMin,doMax,v0,v1){if(isOrd){if(r[axis].indexOf(d[i][key])===-1){r[axis].push(d[i][key])}}else{if(doMin){this._setMin(r[axis],v0)}if(doMax){this._setMax(r[axis],v1)}}}.bind(extentCalc);extentCalc._checkInSeriesConfig=function _checkInSeriesConfig(exts,a){for(var i=0;i<this.seriesToAxes[a].length;i++){var s=this.seriesToAxes[a][i];if(!this.hardMute||!this.mutedSeries[s]){exts[a][0]=this.completeSeriesConfig[s][\"yMin\"]||this.completeSeriesConfig[s][\"yMin\"]===0?Math.min(this.completeSeriesConfig[s][\"yMin\"],exts[a][0]):exts[a][0];exts[a][1]=this.completeSeriesConfig[s][\"yMax\"]||this.completeSeriesConfig[s][\"yMax\"]===0?Math.max(this.completeSeriesConfig[s][\"yMax\"],exts[a][1]):exts[a][1]}}}.bind(extentCalc);extentCalc._applyChartExtents=function _applyChartExtents(exts,a){var k=this.chartExtents[a]?a:\"y\";if(this.chartExtents[k]){if(this.chartExtents[k][0]===\"dynamic\"){exts[a][0]=exts[a][0]||exts[a][0]===0?exts[a][0]:Infinity}else{exts[a][0]=this.chartExtents[k][0]}if(this.chartExtents[k][1]===\"dynamic\"){exts[a][1]=exts[a][1]||exts[a][1]===0?exts[a][1]:-Infinity}else{exts[a][1]=this.chartExtents[k][1]}}}.bind(extentCalc);extentCalc._searchForExtents=function _searchForExtents(exts,seriesToSearch,data){var seriesList=Object.keys(seriesToSearch);for(var i=0;i<data.length;i++){for(var j=0;j<seriesList.length;j++){var s=seriesList[j],sY=this.completeSeriesConfig[s][\"y\"],series=seriesToSearch[s],axis=series[\"axis\"];if(series.min&&(data[i][sY]||data[i][sY]===0)){exts[axis][0]=Math.min(data[i][sY],exts[axis][0])}if(series.max&&(data[i][sY]||data[i][sY]===0)){exts[axis][1]=Math.max(data[i][sY],exts[axis][1])}}}}.bind(extentCalc);extentCalc._calcSeriesToSearch=function _calcSeriesToSearch(exts,a,seriesToSearch){for(var i=0;i<this.seriesToAxes[a].length;i++){var s=this.seriesToAxes[a][i];if(!this.hardMute||!this.mutedSeries[s]){seriesToSearch[s]={axis:a,min:exts[a][0]===Infinity?true:false,max:exts[a][1]===-Infinity?true:false}}}}.bind(extentCalc);extentCalc._calcMultiAxisExtents=function _calcMultiAxisExtents(data){var search=false,exts={},seriesToSearch={},a,keys;for(var i=0;i<this.axes.length;i++){a=this.axes[i];exts[a]=[];exts[a][0]=this._defaultScaleValue.y[0];exts[a][1]=this._defaultScaleValue.y[1];this._checkInSeriesConfig(exts,a);if(this.chartExtents){this._applyChartExtents(exts,a)}if(exts[a][0]===Infinity||exts[a][1]===-Infinity){search=true;this._calcSeriesToSearch(exts,a,seriesToSearch)}}if(search){this._searchForExtents(exts,seriesToSearch,data)}keys=Object.keys(exts);for(var i=0;i<keys.length;i++){if(exts[keys[i]][0]===Infinity||exts[keys[i]][1]===-Infinity){exts[keys[i]]=[0,1]}}return exts}.bind(extentCalc);var dataMapping={},quadtrees={};quadtreeBuilt=false;function reply(data){postMessage({data:data})}function updateData(eventData){dataMapping[eventData.chartId]=eventData.data.chartData;reply(null)}function deleteData(eventData){delete dataMapping[eventData.chartId];delete quadtrees[eventData.chartId];reply(null)}function recreateD3Scale(scaleObj){var result;if(scaleObj.type===\"time\"){result=d3.scaleUtc().nice().range(scaleObj.range).domain(scaleObj.domain)}else if(scaleObj.type===\"timeLocal\"){result=d3.scaleTime().nice().range(scaleObj.range).domain(scaleObj.domain)}else if(scaleObj.type===\"linear\"){result=d3.scaleLinear().nice().range(scaleObj.range).domain(scaleObj.domain)}else if(scaleObj.type===\"scaleBand\"){result=d3.scaleBand().range(scaleObj.range).domain(scaleObj.domain).round(true).paddingInner(.5)}else{result=d3.scalePoint().range(scaleObj.range).domain(scaleObj.domain).padding(.5)}return result}function getMultiScale(visData){var o={},k,axis;for(var i=0;i<visData.keys.length;i++){k=visData.keys[i];axis=visData.isMultiY?visData.completeSeriesConfig[k][\"axis\"][\"id\"]:\"defaultAxis\";if(!o[axis]){o[axis]=recreateD3Scale(visData.y[axis])}}return o}function createDataStub(){return{time:null,timeSeriesKey:null,series:[],seriesObj:{},rawData:[],timeStamps:[],timeStampsTracker:{},additionalPoints:[]}}function flattenData(visData,d,xScale,yScale,index,arr){for(var i=0;i<visData.keys.length;i++){if(visData.hardMute&&visData.mutedSeries[visData.keys[i]]){continue}var o={},k=visData.keys[i],axis=visData.completeSeriesConfig[k][\"axis\"]?visData.completeSeriesConfig[k][\"axis\"][\"id\"]:\"default\";o[\"i\"]=index;o[\"k\"]=k;if(visData.radial){var pix=calcPixelCoordForRadial(d[visData.completeSeriesConfig[k][\"x\"]],d[visData.completeSeriesConfig[k][\"y\"]],axis,visData);o[\"px\"]=~~pix[0];o[\"py\"]=~~pix[1]}else{o[\"px\"]=~~xScale(d[visData.completeSeriesConfig[k][\"x\"]],axis);o[\"py\"]=~~yScale(d[visData.completeSeriesConfig[k][\"y\"]],axis)}arr.push(o)}return arr}function buildQuadtreeHelperObj(visData,k,index,xScale){var obj={},axis=visData.completeSeriesConfig[k][\"axis\"]?visData.completeSeriesConfig[k][\"axis\"][\"id\"]:null;obj.xKey=visData.completeSeriesConfig[k][\"x\"];obj.yKey=visData.completeSeriesConfig[k][\"y\"];if(visData.radial){var calcPx=function(d){return calcPixelCoordForRadial(d[obj.xKey],d[obj.yKey],axis,visData)};obj.xScale=function(d){return calcPx(d)[0]};obj.yScale=function(d){return calcPx(d)[1]};obj.yScale.index=index}else{obj.yScale=recreateD3Scale(visData.y[axis]);obj.yScale.index=index;obj.xScale=recreateD3Scale(visData.x)}return obj}function adjustAngleForPolarChart(angle,toDegrees,visData){var offset=toDegrees?180:Math.PI;if(!visData.counterClockwise&&!toDegrees||visData.counterClockwise&&toDegrees){angle*=-1}if(visData.useDegrees){if(toDegrees){return angle+offset}else{return angle/360*2*Math.PI+offset}}else{if(toDegrees){return angle/(2*Math.PI)*360+offset}else{return angle+offset}}}function calcPixelCoordForRadial(angle,amp,axis,visData){var yRange=visData.y[axis].range[1]-visData.y[axis].range[0],yDomainTot=visData.y[axis].domain[1]-visData.y[axis].domain[0],pixelAmplitude=yRange*(amp-visData.y[axis].domain[0])/yDomainTot;angle=adjustAngleForPolarChart(angle,false,visData);return[Math.sin(angle)*pixelAmplitude,Math.cos(angle)*pixelAmplitude]}function calcXScale(visData){if(!visData.radial){var x=recreateD3Scale(visData.x);return function(d){return x(d)}}}function calcYScale(visData){if(!visData.radial){var y=getMultiScale(visData);return function(d,axis){return y[axis](d)}}}function createSingleQuadtree(data){var visData=data.data,chartData=dataMapping[data.chartId],flatData,xScale=calcXScale(visData),yScale=calcYScale(visData),quadtree;if(chartData){quadtree=d3.quadtree().extent(visData.extents).x(function(d){return d.px}).y(function(d){return d.py});var allFlat=[];for(var i=0;i<chartData.length;i++){flattenData(visData,chartData[i],xScale,yScale,i,allFlat)}quadtree.addAll(allFlat);return quadtree}else{return null}}function createSeriesQuadtree(data){var visData=data.data,chartData=dataMapping[data.chartId],k,quadtree={},xScale=function(d){return visData.radial?this.xScale(d):this.xScale(d[this.xKey])},yScale=function(d){return visData.radial?this.yScale(d):this.yScale(d[this.yKey])};if(chartData){for(var i=0;i<visData.keys.length;i++){k=visData.keys[i];if(visData.hardMute&&visData.mutedSeries[k]){continue}var obj=buildQuadtreeHelperObj(visData,k,i);quadtree[k]=d3.quadtree().extent(visData.extents).x(xScale.bind(obj)).y(yScale.bind(obj)).addAll(chartData)}return quadtree}else{return null}}function createQuadtree(data){quadtreeBuilt=false;quadtrees[data.chartId]=data.data.searchType===\"pointPerSeries\"?createSeriesQuadtree(data):createSingleQuadtree(data);quadtreeBuilt=true;reply(null,null)}function _getPixelSpaceVal(d,chartScale,key,axis){return axis?chartScale[axis](d[key]):chartScale(d[key])}function calcValueQuadtree(d,x,y){var o={};o[x]=d[x];o[y]=d[y];return o}function calcCoordQuadtree(d,x,y,xScale,yScale,visData,axis){var a=[];if(visData.radial){a=calcPixelCoordForRadial(d[x],d[y],axis,visData)}else{a[0]=xScale(d[x]);a[1]=yScale(d[y])}return a}function calcDataSeriesQuadtree(d,k,xScale,yScale,visData,axis){var x=visData.completeSeriesConfig[k][\"x\"],y=visData.completeSeriesConfig[k][\"y\"];return{coord:calcCoordQuadtree(d,x,y,xScale,yScale,visData,axis),name:k,value:calcValueQuadtree(d,x,y)}}function calcClosestPoint(mousePos,foundPoint,series,time){var pixelX=series.coord[0],pixelY=series.coord[1],currDist=(pixelX-=mousePos[0])*pixelX+(pixelY-=mousePos[1])*pixelY;if(!foundPoint||foundPoint.dist>currDist){return{dist:currDist,time:time,key:series.name}}return foundPoint}function calcDataSingleQuadtree(rawData,k,visData){var x=visData.completeSeriesConfig[k][\"x\"],y=visData.completeSeriesConfig[k][\"y\"],axis=visData.completeSeriesConfig[k][\"axis\"]?visData.completeSeriesConfig[k][\"axis\"][\"id\"]:\"default\",value=calcValueQuadtree(rawData,x,y);return{coord:visData.radial?calcPixelCoordForRadial(value[x],value[y],axis,visData):[visData.xScale(value[x]),visData.yScale[axis](value[y])],name:k,value:value}}function addCrosshairDataQuadtree(dataObj,d,timeData){if(timeData&&!dataObj.timeStampsTracker[d[timeData]]){dataObj.rawData.push(d);dataObj.timeStamps.push(d[timeData]);dataObj.timeStampsTracker[d[timeData]]=true}else if(!timeData){dataObj.rawData.push(d)}return dataObj}function constructDataObj(result,dataObj,k,visData,isSingle,xScale){if(!result||visData.hardMute&&visData.mutedSeries[k]||visData.searchFor===\"point\"&&result.k!==k){dataObj.series.push(emptySeries(k))}else if(isSingle){var rawData=this.dataMapping[visData.chartId][result.i];dataObj.seriesObj[k]=calcDataSingleQuadtree(rawData,k,visData);dataObj.series.push(dataObj.seriesObj[k]);if(visData.calcCrosshair&&visData.searchType!==\"allInArea\"){dataObj=addCrosshairDataQuadtree(dataObj,rawData,visData.timeData)}}else{var axis=visData.completeSeriesConfig[k][\"axis\"][\"id\"],yScale=recreateD3Scale(visData.y[axis]),series=calcDataSeriesQuadtree(result,k,xScale,yScale,visData,axis);dataObj.seriesObj[k]=series;dataObj.series.push(series);if(visData.timeData){dataObj.closest=calcClosestPoint(visData.mousePos,dataObj.closest,series,result[visData.timeData])}if(visData.calcCrosshair){dataObj=addCrosshairDataQuadtree(dataObj,result,visData.timeData)}}return dataObj}function calcBoxSize(visData){var x0=visData.mousePos[0]-visData.radius,x1=visData.mousePos[0]+visData.radius,y0=visData.mousePos[1]-visData.radius,y1=visData.mousePos[1]+visData.radius;return{x0:x0,x1:x1,y0:y0,y1:y1}}function calcPolygonExtents(polygon){var xExt=d3.extent(polygon,function(d){return d[0]}),yExt=d3.extent(polygon,function(d){return d[1]});return{x0:xExt[0],x1:xExt[1],y0:yExt[0],y1:yExt[1]}}function searchPolygonQuadtree(visData,dataObj,quadtree){var boxSize=calcPolygonExtents(visData.polygon),scanned=0,selected=0;if(visData.polygon.length){quadtree.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){if(!node.length){do{var d=node.data;scanned++;if(d3.polygonContains(visData.polygon,[d.px,d.py])){dataObj=addCrosshairDataQuadtree(dataObj,this.dataMapping[visData.chartId][node.data.i],visData.timeData);selected++}}while(node=node.next);return true}return nodeX0>=boxSize.x1||nodeY0>=boxSize.y1||nodeX1<boxSize.x0||nodeY1<boxSize.y0})}return dataObj}function searchAreaBoxQuadtree(quadtree,visData,dataObj){var boxSize=calcBoxSize(visData);quadtree.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){if(!node.length){do{var d=node.data;if(d.px>=boxSize.x0&&d.px<boxSize.x1&&d.py>=boxSize.y0&&d.py<boxSize.y1){dataObj=addCrosshairDataQuadtree(dataObj,d.data,visData.timeData)}}while(node=node.next)}return nodeX0>=boxSize.x1||nodeY0>=boxSize.y1||nodeX1<boxSize.x0||nodeY1<boxSize.y0});return dataObj}function searchAreaRadiusQuadtree(quadtree,visData,dataObj){var r2=visData.radius*visData.radius,boxSize=calcBoxSize(visData);quadtree.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){if(!node.length){do{if(!visData.hardMute||!visData.mutedSeries[node.data.k]){if(Math.pow(node.data.px-visData.mousePos[0],2)+Math.pow(node.data.py-visData.mousePos[1],2)<=r2){dataObj=addCrosshairDataQuadtree(dataObj,this.dataMapping[visData.chartId][node.data.i],visData.timeData)}}}while(node=node.next)}return nodeX0>=boxSize.x1||nodeY0>=boxSize.y1||nodeX1<boxSize.x0||nodeY1<boxSize.y0});return dataObj}function searchAreaQuadtree(quadtree,visData,dataObj){return visData.radius?searchAreaRadiusQuadtree(quadtree,visData,dataObj):searchAreaBoxQuadtree(quadtree,visData,dataObj)}function buildQtSingleDataObj(visData,dataObj,result){for(var i=0;i<visData.keys.length;i++){dataObj=constructDataObj(result,dataObj,visData.keys[i],visData,true,null)}if(result){dataObj.time=dataMapping[visData.chartId][result.i][visData.timeData];dataObj.timeSeriesKey=visData.searchFor===\"point\"?result.k:\"\"}return dataObj}function findAllAtPoint(quadtreeData,point,visData){var allResults=[];quadtreeData.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){if(!node.length){do{var d=node.data;if(d.px===point.px&&d.py===point.py){allResults.push(d)}}while(node=node.next)}return nodeX0>point.px||nodeY0>point.py||nodeX1<point.px||nodeY1<point.py});return allResults}function buildAdditionalPoints(visData,allResults,result){var points=[],additionObj,timeStamps={};timeStamps[result.i]=true;for(var i=0;i<allResults.length;i++){if(allResults[i][\"i\"]===result.i&&allResults[i][\"k\"]===result.k){continue}if(visData.searchFor!==\"point\"&&timeStamps[allResults[i][\"i\"]]){continue}additionObj=createDataStub();additionObj=buildQtSingleDataObj(visData,additionObj,allResults[i]);timeStamps[allResults[i][\"i\"]]=true;points.push(additionObj)}return points}function returnAllAtPoint(quadtreeData,visData,result,dataObj){var allResults=findAllAtPoint(quadtreeData,result,visData);if(allResults.length>1){dataObj.additionalPoints=buildAdditionalPoints(visData,allResults,result)}return dataObj}function searchQuadtreeSingle(visData,dataObj,quadtreeData){var r=visData.radius?visData.radius:Infinity,result=quadtreeData.find(visData.mousePos[0],visData.mousePos[1],r);dataObj=buildQtSingleDataObj(visData,dataObj,result);if(result){dataObj=returnAllAtPoint(quadtreeData,visData,result,dataObj)}if(visData.calcCrosshair){if(visData.searchType===\"allInArea\"){dataObj=searchAreaRadiusQuadtree(quadtreeData,visData,dataObj)}}return dataObj}function searchQuadtreeSeries(visData,dataObj,quadtreeData){var r=visData.radius?visData.radius:Infinity,xScale=!visData.radial?recreateD3Scale(visData.x):null,result,k;for(var i=0;i<visData.keys.length;i++){if(quadtreeData[k]){k=visData.keys[i];if(!visData.hardMute||!visData.mutedSeries[k]){result=quadtreeData[k].find(visData.mousePos[0],visData.mousePos[1],r);dataObj=constructDataObj(result,dataObj,k,visData,false,xScale)}}}if(dataObj.closest){dataObj.time=dataObj.closest.time;dataObj.timeSeriesKey=dataObj.closest.key;delete dataObj.closest}return dataObj}function returnClosestsQuadtreePoints(eventData,time){var visData=eventData.data,dataObj=createDataStub(),quadtreeData=quadtrees[eventData.chartId];if(quadtreeData){visData.chartId=eventData.chartId;visData.xScale=recreateD3Scale(visData.x);visData.yScale=getMultiScale(visData);if(visData.searchType===\"pointPerSeries\"){dataObj=searchQuadtreeSeries(visData,dataObj,quadtreeData)}else if(visData.searchType===\"lasso\"){dataObj=searchPolygonQuadtree(visData,dataObj,quadtreeData)}else{dataObj=searchQuadtreeSingle(visData,dataObj,quadtreeData)}}delete dataObj.timeStampsTracker;reply(dataObj)}function returnQuadtreePointsInArea(eventData){var visData=eventData.data,quadtreeData=quadtrees[eventData.chartId],dataObj=createDataStub();if(quadtreeData){visData.chartId=eventData.chartId;visData.xScale=recreateD3Scale(visData.x);visData.yScale=getMultiScale(visData);dataObj=searchAreaBoxQuadtree(quadtreeData,visData,dataObj)}reply(dataObj)}function emptySeries(k){return{coord:[],name:k,value:{}}}function addCrosshairData(dataObj,d){if(this.timeData&&!dataObj.timeStampsTracker[d[this.timeData]]){dataObj.rawData.push(d);dataObj.timeStamps.push(d[this.timeData]);dataObj.timeStampsTracker[d[this.timeData]]=true}else if(!this.timeData){dataObj.rawData.push(d)}return dataObj}function determineExtents(eventData){var visData=eventData.data,extents=null;extentCalc.xAxisType=visData.xAxisType;extentCalc.yAxisType=visData.yAxisType;extentCalc.completeSeriesConfig=visData.completeSeriesConfig;extentCalc.chartExtents=visData.chartExtents;extentCalc.dataExtents=visData.dataExtents;extentCalc.axes=visData.axes;extentCalc.seriesToAxes=visData.seriesToAxes;extentCalc.isYAxisObject=visData.isYAxisObject;extentCalc.mutedSeries=visData.mutedSeries;extentCalc.hardMute=visData.hardMute;if(dataMapping[eventData.chartId]){extents=extentCalc.determineExtents(dataMapping[eventData.chartId])}reply(extents)}onmessage=function(e){switch(e.data.action){case\"registerCustomScript\":if(e.data.data.url){importScripts(e.data.data.url)}reply(null);break;case\"runCustomFunction\":var obj=this[e.data.data.objectName],func,result;if(obj){func=obj[e.data.data.functionName];if(func){result=func(e.data.data.data,e.data.chartId)}else{throw\"Couldn't run custom function \"+e.data.data.functionName+\" on custom Object \"+e.data.data.objectName+\" because the specified function doesn't exist on the specified Object.\"}}else{throw\"Couldn't run custom function \"+e.data.data.functionName+\" on custom Object \"+e.data.data.objectName+\" because the specified Object doesn't exist. Make sure you have loaded your custom script defining the custom object.\"}reply(result);break;case\"updateData\":updateData(e.data);break;case\"createQuadtree\":createQuadtree(e.data);break;case\"findQuadtreePoints\":if(quadtreeBuilt){returnClosestsQuadtreePoints(e.data)}else{reply(null)}break;case\"findQuadtreePointsInArea\":if(quadtreeBuilt){returnQuadtreePointsInArea(e.data)}else{reply(null)}break;case\"returnQuadtreeData\":if(quadtreeBuilt){reply(quadtrees[e.data.chartId])}else{reply(null)}break;case\"determineExtents\":determineExtents(e.data);break;case\"unregisterChart\":deleteData(e.data);break;default:reply(null)}};"}; 
      //end of blob
      Px.vis.workerUrl = window.URL.createObjectURL(new Blob([blob.script]));
    }

    scheduler.workers = [];
    scheduler.queue = [];
    //mapping between chart and webworker: {chartId: webWorkerIndex}
    scheduler.chartWorkerMapping = {};
    scheduler.hasChartData = {};

    //each chart will always use the same web worker. This is to get around
    //the problem of passing a lot of data around, so the thread will have
    //to keep the data for charts in sync
    getWorkerIndexForChart = function(chartId) {

      //if this chart  hasn't been registered yet do it
      if(!scheduler.chartWorkerMapping[chartId] && scheduler.chartWorkerMapping[chartId] !== 0) {
        //crudely "balance" workload by distributing charts equally among threads.
        var mappingKeys = Object.keys(scheduler.chartWorkerMapping),
            workerChartCount = [],
            minCount = Number.MAX_VALUE,
            workerIndex = 0;

        for(var k=0; k<scheduler.workers.length; k++) {
          workerChartCount.push(0);
        }

        for(var i=0; i<mappingKeys.length; i++) {
          //count the number of charts for each worker
            workerChartCount[scheduler.chartWorkerMapping[mappingKeys[i]]]++;
        }

        //pick the web worker with the least charts
        for(var j=0; j<workerChartCount.length; j++) {
          if(workerChartCount[j] < minCount) {
            minCount = workerChartCount[j];
            workerIndex = j;
          }
        }

        //finally assign the worker index for the chart
        scheduler.chartWorkerMapping[chartId] = workerIndex;
      }

      return scheduler.chartWorkerMapping[chartId];
    }

    startWork = function(worker, ctx) {
      worker.inUse = true;

      //don't copy the callback around, just remember it
      worker.ctx = {};
      worker.ctx.successCallback = ctx.successCallback;
      worker.ctx.errorCallback = ctx.errorCallback;
      worker.ctx.action = ctx.action;
      worker.ctx.chartId = ctx.chartId;
      worker.ctx.originatorName = ctx.originatorName;

      window.dispatchEvent(new CustomEvent('px-vis-scheduler-work-start', {'detail': { 'action': ctx.action, 'data': ctx.data, 'chartId': ctx.chartId, 'originatorName': ctx.originatorName}}));

      worker.postMessage({ 'action': ctx.action, 'data': ctx.data, 'chartId': ctx.chartId});
    }

    /**
     * Method to request some work from the web worker. The context object
     * can have the following properties:
     * - action: action to be run in the webworker. See below for list of actions
     * - originatorName: arbitrary string representing who sent the request
     * - chartId: Id of the chart this request relates to. Used to identify which webworker to use and what dataset to use in the webworker
     * - successCallback (optional): callback after successfully running an action in the webworker. The callback will have one parameter holding the result of that action
     * - errorCallback (optional): Callback after an error has been fired during the webworker.
     *
     * Please note successCallback and errorCallback are mutually exclusive:
     * one will be called or the other. If both are defined you are guaranteed
     * to have feedback on your request
     *
     * Each request is uniquely identified through the triplet "action
     * originatorName chartId". When a webworker is busy and a request comes
     * in for this webworker then the request will be queued. If another
     * request with the same triplet identifier comes in it will trump the
     * previously queued request: the request initially queued will be
     * destroyed and the new one will be queued
     *
     * The current list of significant actions is as follows (more can be
     * found by inspecting px-vis-worker.js but are usually meant to be used
     * internally):
     * - runCustomFunction: used to run a function on a custom script that you
 explicitely loaded in the web workers through Px.vis.registerCustomScript. Pass "functionName" and "objectName" in the "data" object of the context
     * - updateData: register a new dataset or update a dataset in the web worker. It will be stored in the dataMapping object, the key being chartId and the value the dataset. pass "chartData" in the data object
     *
     */
    scheduler.process = function(context) {

      //find worker for this chart
      var worker = scheduler.workers[getWorkerIndexForChart(context.chartId)]

      startOrQueueWork(context, worker);
    };

    startOrQueueWork = function(context, worker) {
      // check if we have run updateData before so we can stick stuff in a queue if not
      var hasData = scheduler.hasChartData[context.chartId] ?
      scheduler.hasChartData[context.chartId] : (context.action === 'updateData');

      //start work or queue
      if(!worker.inUse && hasData || context.action === 'unregisterChart') {

        scheduler.hasChartData[context.chartId] = hasData;
        startWork(worker, context);

      } else {
        //worker not available, queue
        var obj,
            found;

        //if we already have an action of this type for this chart remove the old one and replace it with this one
        for(var i=0; i<scheduler.queue[worker.index].length; i++) {

          var obj = scheduler.queue[worker.index][i];
          if(obj.chartId === context.chartId && obj.action === context.action && obj.originatorName === context.originatorName) {
            found = i;
            break;
          }
        }

        if(found || found === 0) {
          scheduler.queue[worker.index].splice(found, 1);
        }

        //now queue
        scheduler.queue[worker.index].push(context);
      }
    };

    //called once a worker has finished a piece of work
    processDone = function(e) {

      window.dispatchEvent(new CustomEvent('px-vis-scheduler-work-end', {'detail': { 'action': this.ctx.action, 'data': e.data.data, 'chartId': this.ctx.chartId, 'originatorName': this.ctx.originatorName}}));

      //store callback and kick off new work before processing results
      var callback = this.ctx.successCallback;

      //cleanup if chart has been unregistered
      if(this.ctx.action === 'unregisterChart') {
        //TODO: clean queues in case something has been added while deleting?
        delete scheduler.chartWorkerMapping[this.ctx.chartId];
        delete scheduler.hasChartData[this.ctx.chartId];

        //clear everything related to this chart
        scheduler.queue[this.index] = scheduler.queue[this.index].filter(function(elem) {
          return elem.chartId !== this.ctx.chartId;
        }.bind(this));
      }

      this.inUse = false;

      //use thread if work queued
      if(scheduler.queue[this.index].length) {

        //get and do work
        var ctx = scheduler.queue[this.index].splice(0, 1)[0];
        startOrQueueWork(ctx, this);
      }

      //run callback with the result
      if(callback) {
        callback(e.data);
      }
    };

    webWorkerError = function(e) {

      window.dispatchEvent(new CustomEvent('px-vis-scheduler-work-error', { 'detail': { 'action': this.ctx.action, 'chartId': this.ctx.chartId, 'originatorName': this.ctx.originatorName}}));

      //cleanup if chart has been unregistered
      if(this.ctx.action === 'unregisterChart') {
        //TODO: clean queues in case something has been added while deleting?
        delete scheduler.chartWorkerMapping[this.ctx.chartId];
      }

      //store callback and kick off new work before processing results
      var callback = this.ctx.errorCallback;

      //use thread if work queued
      if(scheduler.queue[this.index].length) {

        //get and do work
        var ctx = scheduler.queue[this.index].splice(0, 1)[0];
        startWork(this, ctx);
      } else {
        this.inUse = false;
      }

      if(callback) {
        callback();
      }
    };

    //create workers and init queue
    for(var i=0; i<threadCount; i++) {

      try {
        var worker = new Worker(Px.vis.workerUrl);
      } catch(e) {

        //failure
        console.warn('failed to find px-vis web worker file at ' + Px.vis.workerUrl);
        console.warn('the charts won\'t be able to determine their extents or find values')
        return;
      }

      //we can load the worker through a data uri if needed
      scheduler.workers.push(worker);

      worker.inUse = true;
      worker.index = i;
      worker.onmessage = processDone;
      worker.onerror = webWorkerError;
      worker.ctx = {};
      worker.ctx.action = 'init';

      //kick a first dummy communication for each worker.
      //The first comm for each worker is slow (needs to parse script)
      //so do it now in order not to suffer the slowdown when actually needing it
      worker.postMessage({'action': 'init', 'd3Url': Px.vis.workerD3Url});
      scheduler.queue.push([]);
    }

    scheduler.registerCustomScript = function(scriptUrl, successCallback, errorCallback) {

      var regCallback,
          errCallback,
          successCounter = 0,
          errCounter = 0,
          ctx;

      //it should be either all registration will fail or all will succeed
      regCallback = function() {
        successCounter++;
        if(successCounter === scheduler.workers.length) {
          //registration on all ww done
          if(successCallback) {
            successCallback();
          }
        } else if(errCounter > 0 && errorCallback) {
          //got some error, some success... just fire error
          errorCallback();
        }
      };

      errCallback = function() {
        errCounter++;
        if(errCounter === scheduler.workers.length) {
          //all reg failed
          if(errorCallback) {
            errorCallback();
          }

        } else if(successCounter > 0 && errorCallback) {
          //got some error, some success... just fire error
          errorCallback();
        }
      };

      ctx = {
            'action': 'registerCustomScript',
            'data': {
              'url': scriptUrl
            },
            'successCallback': regCallback,
            'errorCallback': errCallback
          };

      //run registration on each worker
      for(var i=0; i<scheduler.workers.length; i++) {
        startWork(scheduler.workers[i], ctx);
      }
    }

    Px.vis.scheduler = scheduler;
    window.dispatchEvent(new CustomEvent('px-vis-worker-ready'));
  }
}());
</script>
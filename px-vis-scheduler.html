<link rel="import" href="px-vis-debugger.html"/>
<script>
(function(){
  if(typeof Px === 'undefined') {
    Px = {};
  }
  Px.vis = Px.vis || {};

  if(!Px.vis.scheduler) {

    window.dispatchEvent(new CustomEvent('px-vis-worker-init'));

    //get number of cores
    var scheduler = {},
        threadCount = Px.vis.maxWorkerCount || navigator.hardwareConcurrency || 4,
        initCounter = 0,
        processDone,
        startWork;

    if(Px.vis.workerUrl) {
      console.warn('Px.vis.workerUrl is no longer needed. Worker files are now loaded via a Blob. You may remove Px.vis.workerUrl and do not need to include the worker files in your build anymore.');
      console.warn('### NOTE: If you are running custom scripts via registerCustomScript, you MUST use an absolute path. Relative paths no longer work with the blob.')
    }
    //!!!!!!!!DO NOT DELETE THE COMMENT BELOW, INSERTION POINT USED USED BY GULP FOR THE BLOB!!!!!!!!!
    //start of blob
    var blob =  {"script":"!function(t,n){\"object\"==typeof exports&&\"undefined\"!=typeof module?n(exports,require(\"d3-color\")):\"function\"==typeof define&&define.amd?define([\"exports\",\"d3-color\"],n):n(t.d3={},t.d3Color)}(this,function(t,n){\"use strict\";var e=function(t,n){return t<n?-1:t>n?1:t>=n?0:NaN},r=function(t){var n;return 1===t.length&&(n=t,t=function(t,r){return e(n(t),r)}),{left:function(n,e,r,i){for(null==r&&(r=0),null==i&&(i=n.length);r<i;){var u=r+i>>>1;t(n[u],e)<0?r=u+1:i=u}return r},right:function(n,e,r,i){for(null==r&&(r=0),null==i&&(i=n.length);r<i;){var u=r+i>>>1;t(n[u],e)>0?i=u:r=u+1}return r}}};var i=r(e).right,u=function(t,n,e){t=+t,n=+n,e=(i=arguments.length)<2?(n=t,t=0,1):i<3?1:+e;for(var r=-1,i=0|Math.max(0,Math.ceil((n-t)/e)),u=new Array(i);++r<i;)u[r]=t+r*e;return u},o=Math.sqrt(50),a=Math.sqrt(10),c=Math.sqrt(2),f=function(t,n,e){var r,i,u,o,a=-1;if(e=+e,(t=+t)===(n=+n)&&e>0)return[t];if((r=n<t)&&(i=t,t=n,n=i),0===(o=l(t,n,e))||!isFinite(o))return[];if(o>0)for(t=Math.ceil(t/o),n=Math.floor(n/o),u=new Array(i=Math.ceil(n-t+1));++a<i;)u[a]=(t+a)*o;else for(t=Math.floor(t*o),n=Math.ceil(n*o),u=new Array(i=Math.ceil(t-n+1));++a<i;)u[a]=(t-a)/o;return r&&u.reverse(),u};function l(t,n,e){var r=(n-t)/Math.max(0,e),i=Math.floor(Math.log(r)/Math.LN10),u=r/Math.pow(10,i);return i>=0?(u>=o?10:u>=a?5:u>=c?2:1)*Math.pow(10,i):-Math.pow(10,-i)/(u>=o?10:u>=a?5:u>=c?2:1)}function s(t,n,e){var r=Math.abs(n-t)/Math.max(0,e),i=Math.pow(10,Math.floor(Math.log(r)/Math.LN10)),u=r/i;return u>=o?i*=10:u>=a?i*=5:u>=c&&(i*=2),n<t?-i:i}function h(){}function g(t,n){var e=new h;if(t instanceof h)t.each(function(t,n){e.set(n,t)});else if(Array.isArray(t)){var r,i=-1,u=t.length;if(null==n)for(;++i<u;)e.set(i,t[i]);else for(;++i<u;)e.set(n(r=t[i],i,t),r)}else if(t)for(var o in t)e.set(o,t[o]);return e}function v(){}h.prototype=g.prototype={constructor:h,has:function(t){return\"$\"+t in this},get:function(t){return this[\"$\"+t]},set:function(t,n){return this[\"$\"+t]=n,this},remove:function(t){var n=\"$\"+t;return n in this&&delete this[n]},clear:function(){for(var t in this)\"$\"===t[0]&&delete this[t]},keys:function(){var t=[];for(var n in this)\"$\"===n[0]&&t.push(n.slice(1));return t},values:function(){var t=[];for(var n in this)\"$\"===n[0]&&t.push(this[n]);return t},entries:function(){var t=[];for(var n in this)\"$\"===n[0]&&t.push({key:n.slice(1),value:this[n]});return t},size:function(){var t=0;for(var n in this)\"$\"===n[0]&&++t;return t},empty:function(){for(var t in this)if(\"$\"===t[0])return!1;return!0},each:function(t){for(var n in this)\"$\"===n[0]&&t(this[n],n.slice(1),this)}};var d=g.prototype;v.prototype=function(t,n){var e=new v;if(t instanceof v)t.each(function(t){e.add(t)});else if(t){var r=-1,i=t.length;if(null==n)for(;++r<i;)e.add(t[r]);else for(;++r<i;)e.add(n(t[r],r,t))}return e}.prototype={constructor:v,has:d.has,add:function(t){return this[\"$\"+(t+=\"\")]=t,this},remove:d.remove,clear:d.clear,values:d.keys,size:d.size,empty:d.empty,each:d.each};var y=Array.prototype,p=y.map,M=y.slice,m={name:\"implicit\"};function x(){var t,n,e=function t(n){var e=g(),r=[],i=m;function u(t){var u=t+\"\",o=e.get(u);if(!o){if(i!==m)return i;e.set(u,o=r.push(t))}return n[(o-1)%n.length]}return n=null==n?[]:M.call(n),u.domain=function(t){if(!arguments.length)return r.slice();r=[],e=g();for(var n,i,o=-1,a=t.length;++o<a;)e.has(i=(n=t[o])+\"\")||e.set(i,r.push(n));return u},u.range=function(t){return arguments.length?(n=M.call(t),u):n.slice()},u.unknown=function(t){return arguments.length?(i=t,u):i},u.copy=function(){return t().domain(r).range(n).unknown(i)},u}().unknown(void 0),r=e.domain,i=e.range,o=[0,1],a=!1,c=0,f=0,l=.5;function s(){var e=r().length,s=o[1]<o[0],h=o[s-0],g=o[1-s];t=(g-h)/Math.max(1,e-c+2*f),a&&(t=Math.floor(t)),h+=(g-h-t*(e-c))*l,n=t*(1-c),a&&(h=Math.round(h),n=Math.round(n));var v=u(e).map(function(n){return h+t*n});return i(s?v.reverse():v)}return delete e.unknown,e.domain=function(t){return arguments.length?(r(t),s()):r()},e.range=function(t){return arguments.length?(o=[+t[0],+t[1]],s()):o.slice()},e.rangeRound=function(t){return o=[+t[0],+t[1]],a=!0,s()},e.bandwidth=function(){return n},e.step=function(){return t},e.round=function(t){return arguments.length?(a=!!t,s()):a},e.padding=function(t){return arguments.length?(c=f=Math.max(0,Math.min(1,t)),s()):c},e.paddingInner=function(t){return arguments.length?(c=Math.max(0,Math.min(1,t)),s()):c},e.paddingOuter=function(t){return arguments.length?(f=Math.max(0,Math.min(1,t)),s()):f},e.align=function(t){return arguments.length?(l=Math.max(0,Math.min(1,t)),s()):l},e.copy=function(){return x().domain(r()).range(o).round(a).paddingInner(c).paddingOuter(f).align(l)},s()}var w=function(t){return function(){return t}};function T(t){return 1==(t=+t)?_:function(n,e){return e-n?(r=n,i=e,u=t,r=Math.pow(r,u),i=Math.pow(i,u)-r,u=1/u,function(t){return Math.pow(r+t*i,u)}):w(isNaN(n)?e:n);var r,i,u}}function _(t,n){var e,r,i=n-t;return i?(e=t,r=i,function(t){return e+t*r}):w(isNaN(t)?n:t)}var C=function t(e){var r=T(e);function i(t,e){var i=r((t=n.rgb(t)).r,(e=n.rgb(e)).r),u=r(t.g,e.g),o=r(t.b,e.b),a=_(t.opacity,e.opacity);return function(n){return t.r=i(n),t.g=u(n),t.b=o(n),t.opacity=a(n),t+\"\"}}return i.gamma=t,i}(1),U=function(t,n){return n-=t=+t,function(e){return t+n*e}},D=/[-+]?(?:\\d+\\.?\\d*|\\.?\\d+)(?:[eE][-+]?\\d+)?/g,b=new RegExp(D.source,\"g\");var A=function(t,e){var r,i=typeof e;return null==e||\"boolean\"===i?w(e):(\"number\"===i?U:\"string\"===i?(r=n.color(e))?(e=r,C):function(t,n){var e,r,i,u,o,a=D.lastIndex=b.lastIndex=0,c=-1,f=[],l=[];for(t+=\"\",n+=\"\";(e=D.exec(t))&&(r=b.exec(n));)(i=r.index)>a&&(i=n.slice(a,i),f[c]?f[c]+=i:f[++c]=i),(e=e[0])===(r=r[0])?f[c]?f[c]+=r:f[++c]=r:(f[++c]=null,l.push({i:c,x:U(e,r)})),a=b.lastIndex;return a<n.length&&(i=n.slice(a),f[c]?f[c]+=i:f[++c]=i),f.length<2?l[0]?(o=l[0].x,function(t){return o(t)+\"\"}):(u=n,function(){return u}):(n=l.length,function(t){for(var e,r=0;r<n;++r)f[(e=l[r]).i]=e.x(t);return f.join(\"\")})}:e instanceof n.color?C:e instanceof Date?function(t,n){var e=new Date;return n-=t=+t,function(r){return e.setTime(t+n*r),e}}:Array.isArray(e)?function(t,n){var e,r=n?n.length:0,i=t?Math.min(r,t.length):0,u=new Array(i),o=new Array(r);for(e=0;e<i;++e)u[e]=A(t[e],n[e]);for(;e<r;++e)o[e]=n[e];return function(t){for(e=0;e<i;++e)o[e]=u[e](t);return o}}:\"function\"!=typeof e.valueOf&&\"function\"!=typeof e.toString||isNaN(e)?function(t,n){var e,r={},i={};null!==t&&\"object\"==typeof t||(t={}),null!==n&&\"object\"==typeof n||(n={});for(e in n)e in t?r[e]=A(t[e],n[e]):i[e]=n[e];return function(t){for(e in r)i[e]=r[e](t);return i}}:U)(t,e)},N=function(t,n){return n-=t=+t,function(e){return Math.round(t+n*e)}},F=(Math.PI,Math.SQRT2,new Date),S=new Date;function Y(t,n,e,r){function i(n){return t(n=new Date(+n)),n}return i.floor=i,i.ceil=function(e){return t(e=new Date(e-1)),n(e,1),t(e),e},i.round=function(t){var n=i(t),e=i.ceil(t);return t-n<e-t?n:e},i.offset=function(t,e){return n(t=new Date(+t),null==e?1:Math.floor(e)),t},i.range=function(e,r,u){var o,a=[];if(e=i.ceil(e),u=null==u?1:Math.floor(u),!(e<r&&u>0))return a;do{a.push(o=new Date(+e)),n(e,u),t(e)}while(o<e&&e<r);return a},i.filter=function(e){return Y(function(n){if(n>=n)for(;t(n),!e(n);)n.setTime(n-1)},function(t,r){if(t>=t)if(r<0)for(;++r<=0;)for(;n(t,-1),!e(t););else for(;--r>=0;)for(;n(t,1),!e(t););})},e&&(i.count=function(n,r){return F.setTime(+n),S.setTime(+r),t(F),t(S),Math.floor(e(F,S))},i.every=function(t){return t=Math.floor(t),isFinite(t)&&t>0?t>1?i.filter(r?function(n){return r(n)%t==0}:function(n){return i.count(0,n)%t==0}):i:null}),i}var H=Y(function(){},function(t,n){t.setTime(+t+n)},function(t,n){return n-t});H.every=function(t){return t=Math.floor(t),isFinite(t)&&t>0?t>1?Y(function(n){n.setTime(Math.floor(n/t)*t)},function(n,e){n.setTime(+n+e*t)},function(n,e){return(e-n)/t}):H:null};var k=6e4,L=6048e5,$=Y(function(t){t.setTime(1e3*Math.floor(t/1e3))},function(t,n){t.setTime(+t+1e3*n)},function(t,n){return(n-t)/1e3},function(t){return t.getUTCSeconds()}),j=Y(function(t){t.setTime(Math.floor(t/k)*k)},function(t,n){t.setTime(+t+n*k)},function(t,n){return(n-t)/k},function(t){return t.getMinutes()}),O=Y(function(t){var n=t.getTimezoneOffset()*k%36e5;n<0&&(n+=36e5),t.setTime(36e5*Math.floor((+t-n)/36e5)+n)},function(t,n){t.setTime(+t+36e5*n)},function(t,n){return(n-t)/36e5},function(t){return t.getHours()}),z=Y(function(t){t.setHours(0,0,0,0)},function(t,n){t.setDate(t.getDate()+n)},function(t,n){return(n-t-(n.getTimezoneOffset()-t.getTimezoneOffset())*k)/864e5},function(t){return t.getDate()-1});function I(t){return Y(function(n){n.setDate(n.getDate()-(n.getDay()+7-t)%7),n.setHours(0,0,0,0)},function(t,n){t.setDate(t.getDate()+7*n)},function(t,n){return(n-t-(n.getTimezoneOffset()-t.getTimezoneOffset())*k)/L})}var Z=I(0),P=I(1),W=(I(2),I(3),I(4)),V=(I(5),I(6),Y(function(t){t.setDate(1),t.setHours(0,0,0,0)},function(t,n){t.setMonth(t.getMonth()+n)},function(t,n){return n.getMonth()-t.getMonth()+12*(n.getFullYear()-t.getFullYear())},function(t){return t.getMonth()})),E=Y(function(t){t.setMonth(0,1),t.setHours(0,0,0,0)},function(t,n){t.setFullYear(t.getFullYear()+n)},function(t,n){return n.getFullYear()-t.getFullYear()},function(t){return t.getFullYear()});E.every=function(t){return isFinite(t=Math.floor(t))&&t>0?Y(function(n){n.setFullYear(Math.floor(n.getFullYear()/t)*t),n.setMonth(0,1),n.setHours(0,0,0,0)},function(n,e){n.setFullYear(n.getFullYear()+e*t)}):null};var Q=Y(function(t){t.setUTCSeconds(0,0)},function(t,n){t.setTime(+t+n*k)},function(t,n){return(n-t)/k},function(t){return t.getUTCMinutes()}),X=Y(function(t){t.setUTCMinutes(0,0,0)},function(t,n){t.setTime(+t+36e5*n)},function(t,n){return(n-t)/36e5},function(t){return t.getUTCHours()}),q=Y(function(t){t.setUTCHours(0,0,0,0)},function(t,n){t.setUTCDate(t.getUTCDate()+n)},function(t,n){return(n-t)/864e5},function(t){return t.getUTCDate()-1});function J(t){return Y(function(n){n.setUTCDate(n.getUTCDate()-(n.getUTCDay()+7-t)%7),n.setUTCHours(0,0,0,0)},function(t,n){t.setUTCDate(t.getUTCDate()+7*n)},function(t,n){return(n-t)/L})}var B=J(0),R=J(1),G=(J(2),J(3),J(4)),K=(J(5),J(6),Y(function(t){t.setUTCDate(1),t.setUTCHours(0,0,0,0)},function(t,n){t.setUTCMonth(t.getUTCMonth()+n)},function(t,n){return n.getUTCMonth()-t.getUTCMonth()+12*(n.getUTCFullYear()-t.getUTCFullYear())},function(t){return t.getUTCMonth()})),tt=Y(function(t){t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0)},function(t,n){t.setUTCFullYear(t.getUTCFullYear()+n)},function(t,n){return n.getUTCFullYear()-t.getUTCFullYear()},function(t){return t.getUTCFullYear()});function nt(t){if(0<=t.y&&t.y<100){var n=new Date(-1,t.m,t.d,t.H,t.M,t.S,t.L);return n.setFullYear(t.y),n}return new Date(t.y,t.m,t.d,t.H,t.M,t.S,t.L)}function et(t){if(0<=t.y&&t.y<100){var n=new Date(Date.UTC(-1,t.m,t.d,t.H,t.M,t.S,t.L));return n.setUTCFullYear(t.y),n}return new Date(Date.UTC(t.y,t.m,t.d,t.H,t.M,t.S,t.L))}function rt(t){return{y:t,m:0,d:1,H:0,M:0,S:0,L:0}}tt.every=function(t){return isFinite(t=Math.floor(t))&&t>0?Y(function(n){n.setUTCFullYear(Math.floor(n.getUTCFullYear()/t)*t),n.setUTCMonth(0,1),n.setUTCHours(0,0,0,0)},function(n,e){n.setUTCFullYear(n.getUTCFullYear()+e*t)}):null};var it,ut,ot,at,ct={\"-\":\"\",_:\" \",0:\"0\"},ft=/^\\s*\\d+/,lt=/^%/,st=/[\\\\^$*+?|[\\]().{}]/g;function ht(t,n,e){var r=t<0?\"-\":\"\",i=(r?-t:t)+\"\",u=i.length;return r+(u<e?new Array(e-u+1).join(n)+i:i)}function gt(t){return t.replace(st,\"\\\\$&\")}function vt(t){return new RegExp(\"^(?:\"+t.map(gt).join(\"|\")+\")\",\"i\")}function dt(t){for(var n={},e=-1,r=t.length;++e<r;)n[t[e].toLowerCase()]=e;return n}function yt(t,n,e){var r=ft.exec(n.slice(e,e+1));return r?(t.w=+r[0],e+r[0].length):-1}function pt(t,n,e){var r=ft.exec(n.slice(e,e+1));return r?(t.u=+r[0],e+r[0].length):-1}function Mt(t,n,e){var r=ft.exec(n.slice(e,e+2));return r?(t.U=+r[0],e+r[0].length):-1}function mt(t,n,e){var r=ft.exec(n.slice(e,e+2));return r?(t.V=+r[0],e+r[0].length):-1}function xt(t,n,e){var r=ft.exec(n.slice(e,e+2));return r?(t.W=+r[0],e+r[0].length):-1}function wt(t,n,e){var r=ft.exec(n.slice(e,e+4));return r?(t.y=+r[0],e+r[0].length):-1}function Tt(t,n,e){var r=ft.exec(n.slice(e,e+2));return r?(t.y=+r[0]+(+r[0]>68?1900:2e3),e+r[0].length):-1}function _t(t,n,e){var r=/^(Z)|([+-]\\d\\d)(?::?(\\d\\d))?/.exec(n.slice(e,e+6));return r?(t.Z=r[1]?0:-(r[2]+(r[3]||\"00\")),e+r[0].length):-1}function Ct(t,n,e){var r=ft.exec(n.slice(e,e+2));return r?(t.m=r[0]-1,e+r[0].length):-1}function Ut(t,n,e){var r=ft.exec(n.slice(e,e+2));return r?(t.d=+r[0],e+r[0].length):-1}function Dt(t,n,e){var r=ft.exec(n.slice(e,e+3));return r?(t.m=0,t.d=+r[0],e+r[0].length):-1}function bt(t,n,e){var r=ft.exec(n.slice(e,e+2));return r?(t.H=+r[0],e+r[0].length):-1}function At(t,n,e){var r=ft.exec(n.slice(e,e+2));return r?(t.M=+r[0],e+r[0].length):-1}function Nt(t,n,e){var r=ft.exec(n.slice(e,e+2));return r?(t.S=+r[0],e+r[0].length):-1}function Ft(t,n,e){var r=ft.exec(n.slice(e,e+3));return r?(t.L=+r[0],e+r[0].length):-1}function St(t,n,e){var r=ft.exec(n.slice(e,e+6));return r?(t.L=Math.floor(r[0]/1e3),e+r[0].length):-1}function Yt(t,n,e){var r=lt.exec(n.slice(e,e+1));return r?e+r[0].length:-1}function Ht(t,n,e){var r=ft.exec(n.slice(e));return r?(t.Q=+r[0],e+r[0].length):-1}function kt(t,n,e){var r=ft.exec(n.slice(e));return r?(t.Q=1e3*+r[0],e+r[0].length):-1}function Lt(t,n){return ht(t.getDate(),n,2)}function $t(t,n){return ht(t.getHours(),n,2)}function jt(t,n){return ht(t.getHours()%12||12,n,2)}function Ot(t,n){return ht(1+z.count(E(t),t),n,3)}function zt(t,n){return ht(t.getMilliseconds(),n,3)}function It(t,n){return zt(t,n)+\"000\"}function Zt(t,n){return ht(t.getMonth()+1,n,2)}function Pt(t,n){return ht(t.getMinutes(),n,2)}function Wt(t,n){return ht(t.getSeconds(),n,2)}function Vt(t){var n=t.getDay();return 0===n?7:n}function Et(t,n){return ht(Z.count(E(t),t),n,2)}function Qt(t,n){var e=t.getDay();return t=e>=4||0===e?W(t):W.ceil(t),ht(W.count(E(t),t)+(4===E(t).getDay()),n,2)}function Xt(t){return t.getDay()}function qt(t,n){return ht(P.count(E(t),t),n,2)}function Jt(t,n){return ht(t.getFullYear()%100,n,2)}function Bt(t,n){return ht(t.getFullYear()%1e4,n,4)}function Rt(t){var n=t.getTimezoneOffset();return(n>0?\"-\":(n*=-1,\"+\"))+ht(n/60|0,\"0\",2)+ht(n%60,\"0\",2)}function Gt(t,n){return ht(t.getUTCDate(),n,2)}function Kt(t,n){return ht(t.getUTCHours(),n,2)}function tn(t,n){return ht(t.getUTCHours()%12||12,n,2)}function nn(t,n){return ht(1+q.count(tt(t),t),n,3)}function en(t,n){return ht(t.getUTCMilliseconds(),n,3)}function rn(t,n){return en(t,n)+\"000\"}function un(t,n){return ht(t.getUTCMonth()+1,n,2)}function on(t,n){return ht(t.getUTCMinutes(),n,2)}function an(t,n){return ht(t.getUTCSeconds(),n,2)}function cn(t){var n=t.getUTCDay();return 0===n?7:n}function fn(t,n){return ht(B.count(tt(t),t),n,2)}function ln(t,n){var e=t.getUTCDay();return t=e>=4||0===e?G(t):G.ceil(t),ht(G.count(tt(t),t)+(4===tt(t).getUTCDay()),n,2)}function sn(t){return t.getUTCDay()}function hn(t,n){return ht(R.count(tt(t),t),n,2)}function gn(t,n){return ht(t.getUTCFullYear()%100,n,2)}function vn(t,n){return ht(t.getUTCFullYear()%1e4,n,4)}function dn(){return\"+0000\"}function yn(){return\"%\"}function pn(t){return+t}function Mn(t){return Math.floor(+t/1e3)}it=function(t){var n=t.dateTime,e=t.date,r=t.time,i=t.periods,u=t.days,o=t.shortDays,a=t.months,c=t.shortMonths,f=vt(i),l=dt(i),s=vt(u),h=dt(u),g=vt(o),v=dt(o),d=vt(a),y=dt(a),p=vt(c),M=dt(c),m={a:function(t){return o[t.getDay()]},A:function(t){return u[t.getDay()]},b:function(t){return c[t.getMonth()]},B:function(t){return a[t.getMonth()]},c:null,d:Lt,e:Lt,f:It,H:$t,I:jt,j:Ot,L:zt,m:Zt,M:Pt,p:function(t){return i[+(t.getHours()>=12)]},Q:pn,s:Mn,S:Wt,u:Vt,U:Et,V:Qt,w:Xt,W:qt,x:null,X:null,y:Jt,Y:Bt,Z:Rt,\"%\":yn},x={a:function(t){return o[t.getUTCDay()]},A:function(t){return u[t.getUTCDay()]},b:function(t){return c[t.getUTCMonth()]},B:function(t){return a[t.getUTCMonth()]},c:null,d:Gt,e:Gt,f:rn,H:Kt,I:tn,j:nn,L:en,m:un,M:on,p:function(t){return i[+(t.getUTCHours()>=12)]},Q:pn,s:Mn,S:an,u:cn,U:fn,V:ln,w:sn,W:hn,x:null,X:null,y:gn,Y:vn,Z:dn,\"%\":yn},w={a:function(t,n,e){var r=g.exec(n.slice(e));return r?(t.w=v[r[0].toLowerCase()],e+r[0].length):-1},A:function(t,n,e){var r=s.exec(n.slice(e));return r?(t.w=h[r[0].toLowerCase()],e+r[0].length):-1},b:function(t,n,e){var r=p.exec(n.slice(e));return r?(t.m=M[r[0].toLowerCase()],e+r[0].length):-1},B:function(t,n,e){var r=d.exec(n.slice(e));return r?(t.m=y[r[0].toLowerCase()],e+r[0].length):-1},c:function(t,e,r){return C(t,n,e,r)},d:Ut,e:Ut,f:St,H:bt,I:bt,j:Dt,L:Ft,m:Ct,M:At,p:function(t,n,e){var r=f.exec(n.slice(e));return r?(t.p=l[r[0].toLowerCase()],e+r[0].length):-1},Q:Ht,s:kt,S:Nt,u:pt,U:Mt,V:mt,w:yt,W:xt,x:function(t,n,r){return C(t,e,n,r)},X:function(t,n,e){return C(t,r,n,e)},y:Tt,Y:wt,Z:_t,\"%\":Yt};function T(t,n){return function(e){var r,i,u,o=[],a=-1,c=0,f=t.length;for(e instanceof Date||(e=new Date(+e));++a<f;)37===t.charCodeAt(a)&&(o.push(t.slice(c,a)),null!=(i=ct[r=t.charAt(++a)])?r=t.charAt(++a):i=\"e\"===r?\" \":\"0\",(u=n[r])&&(r=u(e,i)),o.push(r),c=a+1);return o.push(t.slice(c,a)),o.join(\"\")}}function _(t,n){return function(e){var r,i,u=rt(1900);if(C(u,t,e+=\"\",0)!=e.length)return null;if(\"Q\"in u)return new Date(u.Q);if(\"p\"in u&&(u.H=u.H%12+12*u.p),\"V\"in u){if(u.V<1||u.V>53)return null;\"w\"in u||(u.w=1),\"Z\"in u?(r=(i=(r=et(rt(u.y))).getUTCDay())>4||0===i?R.ceil(r):R(r),r=q.offset(r,7*(u.V-1)),u.y=r.getUTCFullYear(),u.m=r.getUTCMonth(),u.d=r.getUTCDate()+(u.w+6)%7):(r=(i=(r=n(rt(u.y))).getDay())>4||0===i?P.ceil(r):P(r),r=z.offset(r,7*(u.V-1)),u.y=r.getFullYear(),u.m=r.getMonth(),u.d=r.getDate()+(u.w+6)%7)}else(\"W\"in u||\"U\"in u)&&(\"w\"in u||(u.w=\"u\"in u?u.u%7:\"W\"in u?1:0),i=\"Z\"in u?et(rt(u.y)).getUTCDay():n(rt(u.y)).getDay(),u.m=0,u.d=\"W\"in u?(u.w+6)%7+7*u.W-(i+5)%7:u.w+7*u.U-(i+6)%7);return\"Z\"in u?(u.H+=u.Z/100|0,u.M+=u.Z%100,et(u)):n(u)}}function C(t,n,e,r){for(var i,u,o=0,a=n.length,c=e.length;o<a;){if(r>=c)return-1;if(37===(i=n.charCodeAt(o++))){if(i=n.charAt(o++),!(u=w[i in ct?n.charAt(o++):i])||(r=u(t,e,r))<0)return-1}else if(i!=e.charCodeAt(r++))return-1}return r}return m.x=T(e,m),m.X=T(r,m),m.c=T(n,m),x.x=T(e,x),x.X=T(r,x),x.c=T(n,x),{format:function(t){var n=T(t+=\"\",m);return n.toString=function(){return t},n},parse:function(t){var n=_(t+=\"\",nt);return n.toString=function(){return t},n},utcFormat:function(t){var n=T(t+=\"\",x);return n.toString=function(){return t},n},utcParse:function(t){var n=_(t,et);return n.toString=function(){return t},n}}}({dateTime:\"%x, %X\",date:\"%-m/%-d/%Y\",time:\"%-I:%M:%S %p\",periods:[\"AM\",\"PM\"],days:[\"Sunday\",\"Monday\",\"Tuesday\",\"Wednesday\",\"Thursday\",\"Friday\",\"Saturday\"],shortDays:[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"],months:[\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],shortMonths:[\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"]}),ut=it.format,it.parse,ot=it.utcFormat,at=it.utcParse;var mn=\"%Y-%m-%dT%H:%M:%S.%LZ\";Date.prototype.toISOString||ot(mn);+new Date(\"2000-01-01T00:00:00.000Z\")||at(mn);var xn=function(t){return function(){return t}},wn=function(t){return+t},Tn=[0,1];function _n(t,n){return(n-=t=+t)?function(e){return(e-t)/n}:xn(n)}function Cn(t,n,e,r){var i=t[0],u=t[1],o=n[0],a=n[1];return u<i?(i=e(u,i),o=r(a,o)):(i=e(i,u),o=r(o,a)),function(t){return o(i(t))}}function Un(t,n,e,r){var u=Math.min(t.length,n.length)-1,o=new Array(u),a=new Array(u),c=-1;for(t[u]<t[0]&&(t=t.slice().reverse(),n=n.slice().reverse());++c<u;)o[c]=e(t[c],t[c+1]),a[c]=r(n[c],n[c+1]);return function(n){var e=i(t,n,1,u)-1;return a[e](o[e](n))}}function Dn(t,n){return n.domain(t.domain()).range(t.range()).interpolate(t.interpolate()).clamp(t.clamp())}function bn(t,n){var e,r,i,u=Tn,o=Tn,a=A,c=!1;function f(){return e=Math.min(u.length,o.length)>2?Un:Cn,r=i=null,l}function l(n){return(r||(r=e(u,o,c?(i=t,function(t,n){var e=i(t=+t,n=+n);return function(r){return r<=t?0:r>=n?1:e(r)}}):t,a)))(+n);var i}return l.invert=function(t){return(i||(i=e(o,u,_n,c?(r=n,function(t,n){var e=r(t=+t,n=+n);return function(r){return r<=0?t:r>=1?n:e(r)}}):n)))(+t);var r},l.domain=function(t){return arguments.length?(u=p.call(t,wn),f()):u.slice()},l.range=function(t){return arguments.length?(o=M.call(t),f()):o.slice()},l.rangeRound=function(t){return o=M.call(t),a=N,f()},l.clamp=function(t){return arguments.length?(c=!!t,f()):c},l.interpolate=function(t){return arguments.length?(a=t,f()):a},f()}var An=function(t,n){var e,r=0,i=(t=t.slice()).length-1,u=t[r],o=t[i];return o<u&&(e=r,r=i,i=e,e=u,u=o,o=e),t[r]=n.floor(u),t[i]=n.ceil(o),t},Nn=1e3,Fn=60*Nn,Sn=60*Fn,Yn=24*Sn,Hn=7*Yn,kn=30*Yn,Ln=365*Yn;function $n(t){return new Date(t)}function jn(t){return t instanceof Date?+t:+new Date(+t)}function On(t,n,e,i,u,o,a,c,f){var l=bn(_n,U),h=l.invert,g=l.domain,v=f(\".%L\"),d=f(\":%S\"),y=f(\"%I:%M\"),M=f(\"%I %p\"),m=f(\"%a %d\"),x=f(\"%b %d\"),w=f(\"%B\"),T=f(\"%Y\"),_=[[a,1,Nn],[a,5,5*Nn],[a,15,15*Nn],[a,30,30*Nn],[o,1,Fn],[o,5,5*Fn],[o,15,15*Fn],[o,30,30*Fn],[u,1,Sn],[u,3,3*Sn],[u,6,6*Sn],[u,12,12*Sn],[i,1,Yn],[i,2,2*Yn],[e,1,Hn],[n,1,kn],[n,3,3*kn],[t,1,Ln]];function C(r){return(a(r)<r?v:o(r)<r?d:u(r)<r?y:i(r)<r?M:n(r)<r?e(r)<r?m:x:t(r)<r?w:T)(r)}function D(n,e,i,u){if(null==n&&(n=10),\"number\"==typeof n){var o=Math.abs(i-e)/n,a=r(function(t){return t[2]}).right(_,o);a===_.length?(u=s(e/Ln,i/Ln,n),n=t):a?(u=(a=_[o/_[a-1][2]<_[a][2]/o?a-1:a])[1],n=a[0]):(u=Math.max(s(e,i,n),1),n=c)}return null==u?n:n.every(u)}return l.invert=function(t){return new Date(h(t))},l.domain=function(t){return arguments.length?g(p.call(t,jn)):g().map($n)},l.ticks=function(t,n){var e,r=g(),i=r[0],u=r[r.length-1],o=u<i;return o&&(e=i,i=u,u=e),e=(e=D(t,i,u,n))?e.range(i,u+1):[],o?e.reverse():e},l.tickFormat=function(t,n){return null==n?C:f(n)},l.nice=function(t,n){var e=g();return(t=D(t,e[0],e[e.length-1],n))?g(An(e,t)):l},l.copy=function(){return Dn(l,On(t,n,e,i,u,o,a,c,f))},l}var zn,In=function(t,n){if((e=(t=n?t.toExponential(n-1):t.toExponential()).indexOf(\"e\"))<0)return null;var e,r=t.slice(0,e);return[r.length>1?r[0]+r.slice(2):r,+t.slice(e+1)]},Zn=function(t){return(t=In(Math.abs(t)))?t[1]:NaN},Pn=function(t,n){var e=In(t,n);if(!e)return t+\"\";var r=e[0],i=e[1];return i<0?\"0.\"+new Array(-i).join(\"0\")+r:r.length>i+1?r.slice(0,i+1)+\".\"+r.slice(i+1):r+new Array(i-r.length+2).join(\"0\")},Wn={\"\":function(t,n){t=t.toPrecision(n);t:for(var e,r=t.length,i=1,u=-1;i<r;++i)switch(t[i]){case\".\":u=e=i;break;case\"0\":0===u&&(u=i),e=i;break;case\"e\":break t;default:u>0&&(u=0)}return u>0?t.slice(0,u)+t.slice(e+1):t},\"%\":function(t,n){return(100*t).toFixed(n)},b:function(t){return Math.round(t).toString(2)},c:function(t){return t+\"\"},d:function(t){return Math.round(t).toString(10)},e:function(t,n){return t.toExponential(n)},f:function(t,n){return t.toFixed(n)},g:function(t,n){return t.toPrecision(n)},o:function(t){return Math.round(t).toString(8)},p:function(t,n){return Pn(100*t,n)},r:Pn,s:function(t,n){var e=In(t,n);if(!e)return t+\"\";var r=e[0],i=e[1],u=i-(zn=3*Math.max(-8,Math.min(8,Math.floor(i/3))))+1,o=r.length;return u===o?r:u>o?r+new Array(u-o+1).join(\"0\"):u>0?r.slice(0,u)+\".\"+r.slice(u):\"0.\"+new Array(1-u).join(\"0\")+In(t,Math.max(0,n+u-1))[0]},X:function(t){return Math.round(t).toString(16).toUpperCase()},x:function(t){return Math.round(t).toString(16)}},Vn=/^(?:(.)?([<>=^]))?([+\\-\\( ])?([$#])?(0)?(\\d+)?(,)?(\\.\\d+)?([a-z%])?$/i;function En(t){return new Qn(t)}function Qn(t){if(!(n=Vn.exec(t)))throw new Error(\"invalid format: \"+t);var n,e=n[1]||\" \",r=n[2]||\">\",i=n[3]||\"-\",u=n[4]||\"\",o=!!n[5],a=n[6]&&+n[6],c=!!n[7],f=n[8]&&+n[8].slice(1),l=n[9]||\"\";\"n\"===l?(c=!0,l=\"g\"):Wn[l]||(l=\"\"),(o||\"0\"===e&&\"=\"===r)&&(o=!0,e=\"0\",r=\"=\"),this.fill=e,this.align=r,this.sign=i,this.symbol=u,this.zero=o,this.width=a,this.comma=c,this.precision=f,this.type=l}En.prototype=Qn.prototype,Qn.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?\"0\":\"\")+(null==this.width?\"\":Math.max(1,0|this.width))+(this.comma?\",\":\"\")+(null==this.precision?\"\":\".\"+Math.max(0,0|this.precision))+this.type};var Xn,qn,Jn,Bn=function(t){return t},Rn=[\"y\",\"z\",\"a\",\"f\",\"p\",\"n\",\"Âµ\",\"m\",\"\",\"k\",\"M\",\"G\",\"T\",\"P\",\"E\",\"Z\",\"Y\"];Xn=function(t){var n,e,r,i=t.grouping&&t.thousands?(e=t.grouping,r=t.thousands,function(t,n){for(var i=t.length,u=[],o=0,a=e[0],c=0;i>0&&a>0&&(c+a+1>n&&(a=Math.max(1,n-c)),u.push(t.substring(i-=a,i+a)),!((c+=a+1)>n));)a=e[o=(o+1)%e.length];return u.reverse().join(r)}):Bn,u=t.currency,o=t.decimal,a=t.numerals?(n=t.numerals,function(t){return t.replace(/[0-9]/g,function(t){return n[+t]})}):Bn,c=t.percent||\"%\";function f(t){var n=(t=En(t)).fill,e=t.align,r=t.sign,f=t.symbol,l=t.zero,s=t.width,h=t.comma,g=t.precision,v=t.type,d=\"$\"===f?u[0]:\"#\"===f&&/[boxX]/.test(v)?\"0\"+v.toLowerCase():\"\",y=\"$\"===f?u[1]:/[%p]/.test(v)?c:\"\",p=Wn[v],M=!v||/[defgprs%]/.test(v);function m(t){var u,c,f,m=d,x=y;if(\"c\"===v)x=p(t)+x,t=\"\";else{var w=(t=+t)<0;if(t=p(Math.abs(t),g),w&&0==+t&&(w=!1),m=(w?\"(\"===r?r:\"-\":\"-\"===r||\"(\"===r?\"\":r)+m,x=(\"s\"===v?Rn[8+zn/3]:\"\")+x+(w&&\"(\"===r?\")\":\"\"),M)for(u=-1,c=t.length;++u<c;)if(48>(f=t.charCodeAt(u))||f>57){x=(46===f?o+t.slice(u+1):t.slice(u))+x,t=t.slice(0,u);break}}h&&!l&&(t=i(t,1/0));var T=m.length+t.length+x.length,_=T<s?new Array(s-T+1).join(n):\"\";switch(h&&l&&(t=i(_+t,_.length?s-x.length:1/0),_=\"\"),e){case\"<\":t=m+t+x+_;break;case\"=\":t=m+_+t+x;break;case\"^\":t=_.slice(0,T=_.length>>1)+m+t+x+_.slice(T);break;default:t=_+m+t+x}return a(t)}return g=null==g?v?6:12:/[gprs]/.test(v)?Math.max(1,Math.min(21,g)):Math.max(0,Math.min(20,g)),m.toString=function(){return t+\"\"},m}return{format:f,formatPrefix:function(t,n){var e=f(((t=En(t)).type=\"f\",t)),r=3*Math.max(-8,Math.min(8,Math.floor(Zn(n)/3))),i=Math.pow(10,-r),u=Rn[8+r/3];return function(t){return e(i*t)+u}}}}({decimal:\".\",thousands:\",\",grouping:[3],currency:[\"$\",\"\"]}),qn=Xn.format,Jn=Xn.formatPrefix;var Gn=function(t,n,e){var r,i,u,o,a,c,f=t[0],l=t[t.length-1],h=s(f,l,null==n?10:n);switch((e=En(null==e?\",f\":e)).type){case\"s\":var g=Math.max(Math.abs(f),Math.abs(l));return null!=e.precision||isNaN((a=h,c=g,r=Math.max(0,3*Math.max(-8,Math.min(8,Math.floor(Zn(c)/3)))-Zn(Math.abs(a)))))||(e.precision=r),Jn(e,g);case\"\":case\"e\":case\"g\":case\"p\":case\"r\":null!=e.precision||isNaN((u=h,o=Math.max(Math.abs(f),Math.abs(l)),u=Math.abs(u),o=Math.abs(o)-u,r=Math.max(0,Zn(o)-Zn(u))+1))||(e.precision=r-(\"e\"===e.type));break;case\"f\":case\"%\":null!=e.precision||isNaN((i=h,r=Math.max(0,-Zn(Math.abs(i)))))||(e.precision=r-2*(\"%\"===e.type))}return qn(e)};function Kn(t,n,e,r){if(isNaN(n)||isNaN(e))return t;var i,u,o,a,c,f,l,s,h,g=t._root,v={data:r},d=t._x0,y=t._y0,p=t._x1,M=t._y1;if(!g)return t._root=v,t;for(;g.length;)if((f=n>=(u=(d+p)/2))?d=u:p=u,(l=e>=(o=(y+M)/2))?y=o:M=o,i=g,!(g=g[s=l<<1|f]))return i[s]=v,t;if(a=+t._x.call(null,g.data),c=+t._y.call(null,g.data),n===a&&e===c)return v.next=g,i?i[s]=v:t._root=v,t;do{i=i?i[s]=new Array(4):t._root=new Array(4),(f=n>=(u=(d+p)/2))?d=u:p=u,(l=e>=(o=(y+M)/2))?y=o:M=o}while((s=l<<1|f)==(h=(c>=o)<<1|a>=u));return i[h]=g,i[s]=v,t}var te=function(t,n,e,r,i){this.node=t,this.x0=n,this.y0=e,this.x1=r,this.y1=i};function ne(t){return t[0]}function ee(t){return t[1]}function re(t,n,e){var r=new ie(null==n?ne:n,null==e?ee:e,NaN,NaN,NaN,NaN);return null==t?r:r.addAll(t)}function ie(t,n,e,r,i,u){this._x=t,this._y=n,this._x0=e,this._y0=r,this._x1=i,this._y1=u,this._root=void 0}function ue(t){for(var n={data:t.data},e=n;t=t.next;)e=e.next={data:t.data};return n}var oe=re.prototype=ie.prototype;oe.copy=function(){var t,n,e=new ie(this._x,this._y,this._x0,this._y0,this._x1,this._y1),r=this._root;if(!r)return e;if(!r.length)return e._root=ue(r),e;for(t=[{source:r,target:e._root=new Array(4)}];r=t.pop();)for(var i=0;i<4;++i)(n=r.source[i])&&(n.length?t.push({source:n,target:r.target[i]=new Array(4)}):r.target[i]=ue(n));return e},oe.add=function(t){var n=+this._x.call(null,t),e=+this._y.call(null,t);return Kn(this.cover(n,e),n,e,t)},oe.addAll=function(t){var n,e,r,i,u=t.length,o=new Array(u),a=new Array(u),c=1/0,f=1/0,l=-1/0,s=-1/0;for(e=0;e<u;++e)isNaN(r=+this._x.call(null,n=t[e]))||isNaN(i=+this._y.call(null,n))||(o[e]=r,a[e]=i,r<c&&(c=r),r>l&&(l=r),i<f&&(f=i),i>s&&(s=i));for(l<c&&(c=this._x0,l=this._x1),s<f&&(f=this._y0,s=this._y1),this.cover(c,f).cover(l,s),e=0;e<u;++e)Kn(this,o[e],a[e],t[e]);return this},oe.cover=function(t,n){if(isNaN(t=+t)||isNaN(n=+n))return this;var e=this._x0,r=this._y0,i=this._x1,u=this._y1;if(isNaN(e))i=(e=Math.floor(t))+1,u=(r=Math.floor(n))+1;else{if(!(e>t||t>i||r>n||n>u))return this;var o,a,c=i-e,f=this._root;switch(a=(n<(r+u)/2)<<1|t<(e+i)/2){case 0:do{o=new Array(4),o[a]=f,f=o}while(u=r+(c*=2),t>(i=e+c)||n>u);break;case 1:do{o=new Array(4),o[a]=f,f=o}while(u=r+(c*=2),(e=i-c)>t||n>u);break;case 2:do{o=new Array(4),o[a]=f,f=o}while(r=u-(c*=2),t>(i=e+c)||r>n);break;case 3:do{o=new Array(4),o[a]=f,f=o}while(r=u-(c*=2),(e=i-c)>t||r>n)}this._root&&this._root.length&&(this._root=f)}return this._x0=e,this._y0=r,this._x1=i,this._y1=u,this},oe.data=function(){var t=[];return this.visit(function(n){if(!n.length)do{t.push(n.data)}while(n=n.next)}),t},oe.extent=function(t){return arguments.length?this.cover(+t[0][0],+t[0][1]).cover(+t[1][0],+t[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]},oe.find=function(t,n,e){var r,i,u,o,a,c,f,l=this._x0,s=this._y0,h=this._x1,g=this._y1,v=[],d=this._root;for(d&&v.push(new te(d,l,s,h,g)),null==e?e=1/0:(l=t-e,s=n-e,h=t+e,g=n+e,e*=e);c=v.pop();)if(!(!(d=c.node)||(i=c.x0)>h||(u=c.y0)>g||(o=c.x1)<l||(a=c.y1)<s))if(d.length){var y=(i+o)/2,p=(u+a)/2;v.push(new te(d[3],y,p,o,a),new te(d[2],i,p,y,a),new te(d[1],y,u,o,p),new te(d[0],i,u,y,p)),(f=(n>=p)<<1|t>=y)&&(c=v[v.length-1],v[v.length-1]=v[v.length-1-f],v[v.length-1-f]=c)}else{var M=t-+this._x.call(null,d.data),m=n-+this._y.call(null,d.data),x=M*M+m*m;if(x<e){var w=Math.sqrt(e=x);l=t-w,s=n-w,h=t+w,g=n+w,r=d.data}}return r},oe.remove=function(t){if(isNaN(u=+this._x.call(null,t))||isNaN(o=+this._y.call(null,t)))return this;var n,e,r,i,u,o,a,c,f,l,s,h,g=this._root,v=this._x0,d=this._y0,y=this._x1,p=this._y1;if(!g)return this;if(g.length)for(;;){if((f=u>=(a=(v+y)/2))?v=a:y=a,(l=o>=(c=(d+p)/2))?d=c:p=c,n=g,!(g=g[s=l<<1|f]))return this;if(!g.length)break;(n[s+1&3]||n[s+2&3]||n[s+3&3])&&(e=n,h=s)}for(;g.data!==t;)if(r=g,!(g=g.next))return this;return(i=g.next)&&delete g.next,r?(i?r.next=i:delete r.next,this):n?(i?n[s]=i:delete n[s],(g=n[0]||n[1]||n[2]||n[3])&&g===(n[3]||n[2]||n[1]||n[0])&&!g.length&&(e?e[h]=g:this._root=g),this):(this._root=i,this)},oe.removeAll=function(t){for(var n=0,e=t.length;n<e;++n)this.remove(t[n]);return this},oe.root=function(){return this._root},oe.size=function(){var t=0;return this.visit(function(n){if(!n.length)do{++t}while(n=n.next)}),t},oe.visit=function(t){var n,e,r,i,u,o,a=[],c=this._root;for(c&&a.push(new te(c,this._x0,this._y0,this._x1,this._y1));n=a.pop();)if(!t(c=n.node,r=n.x0,i=n.y0,u=n.x1,o=n.y1)&&c.length){var f=(r+u)/2,l=(i+o)/2;(e=c[3])&&a.push(new te(e,f,l,u,o)),(e=c[2])&&a.push(new te(e,r,l,f,o)),(e=c[1])&&a.push(new te(e,f,i,u,l)),(e=c[0])&&a.push(new te(e,r,i,f,l))}return this},oe.visitAfter=function(t){var n,e=[],r=[];for(this._root&&e.push(new te(this._root,this._x0,this._y0,this._x1,this._y1));n=e.pop();){var i=n.node;if(i.length){var u,o=n.x0,a=n.y0,c=n.x1,f=n.y1,l=(o+c)/2,s=(a+f)/2;(u=i[0])&&e.push(new te(u,o,a,l,s)),(u=i[1])&&e.push(new te(u,l,a,c,s)),(u=i[2])&&e.push(new te(u,o,s,l,f)),(u=i[3])&&e.push(new te(u,l,s,c,f))}r.push(n)}for(;n=r.pop();)t(n.node,n.x0,n.y0,n.x1,n.y1);return this},oe.x=function(t){return arguments.length?(this._x=t,this):this._x},oe.y=function(t){return arguments.length?(this._y=t,this):this._y},t.scaleBand=x,t.scalePoint=function(){return function t(n){var e=n.copy;return n.padding=n.paddingOuter,delete n.paddingInner,delete n.paddingOuter,n.copy=function(){return t(e())},n}(x().paddingInner(1))},t.scaleTime=function(){return On(E,V,Z,z,O,j,$,H,ut).domain([new Date(2e3,0,1),new Date(2e3,0,2)])},t.scaleUtc=function(){return On(tt,K,B,q,X,Q,$,H,ot).domain([Date.UTC(2e3,0,1),Date.UTC(2e3,0,2)])},t.scaleLinear=function t(){var n,e,r=bn(_n,U);return r.copy=function(){return Dn(r,t())},e=(n=r).domain,n.ticks=function(t){var n=e();return f(n[0],n[n.length-1],null==t?10:t)},n.tickFormat=function(t,n){return Gn(e(),t,n)},n.nice=function(t){null==t&&(t=10);var r,i=e(),u=0,o=i.length-1,a=i[u],c=i[o];return c<a&&(r=a,a=c,c=r,r=u,u=o,o=r),(r=l(a,c,t))>0?r=l(a=Math.floor(a/r)*r,c=Math.ceil(c/r)*r,t):r<0&&(r=l(a=Math.ceil(a*r)/r,c=Math.floor(c*r)/r,t)),r>0?(i[u]=Math.floor(a/r)*r,i[o]=Math.ceil(c/r)*r,e(i)):r<0&&(i[u]=Math.ceil(a*r)/r,i[o]=Math.floor(c*r)/r,e(i)),n},n},t.extent=function(t,n){var e,r,i,u=t.length,o=-1;if(null==n){for(;++o<u;)if(null!=(e=t[o])&&e>=e)for(r=i=e;++o<u;)null!=(e=t[o])&&(r>e&&(r=e),i<e&&(i=e))}else for(;++o<u;)if(null!=(e=n(t[o],o,t))&&e>=e)for(r=i=e;++o<u;)null!=(e=n(t[o],o,t))&&(r>e&&(r=e),i<e&&(i=e));return[r,i]},t.polygonContains=function(t,n){for(var e,r,i=t.length,u=t[i-1],o=n[0],a=n[1],c=u[0],f=u[1],l=!1,s=0;s<i;++s)e=(u=t[s])[0],(r=u[1])>a!=f>a&&o<(c-e)*(a-r)/(f-r)+e&&(l=!l),c=e,f=r;return l},t.quadtree=re,Object.defineProperty(t,\"__esModule\",{value:!0})});var extentCalc={};extentCalc._defaultScaleValue={x:[Infinity,-Infinity],y:[Infinity,-Infinity]};extentCalc.determineExtents=function determineExtents(data){var xOrd=this.xAxisType===\"ordinal\"||this.xAxisType===\"scaleBand\",yOrd=this.yAxisType===\"ordinal\"||this.yAxisType===\"scaleBand\",xTime=this.xAxisType===\"time\"||this.xAxisType===\"timeLocal\",doX=xTime?false:true,doY=true,keys=Object.keys(this.completeSeriesConfig),extents={x:[],y:[]};extents.x=this._checkForExtents(xOrd,this.chartExtents,this.dataExtents,\"x\");extents.y=this.axes&&this.axes.length?this._calcMultiAxisExtents(data):this._checkForExtents(yOrd,this.chartExtents,this.dataExtents,\"y\");if(extents.x.length>0&&extents.x[0]!==Infinity&&extents.x[1]!==-Infinity){xTime=false;doX=false}if(!Array.isArray(extents.y)||extents.y.length>0&&extents.y[0]!==Infinity&&extents.y[1]!==-Infinity){doY=false}if(data.length===0){xTime=false;doX=false;doY=false}if(doX||doY||xTime){this._findMinMax(data,doX,doY,xOrd,yOrd,xTime,extents,keys)}if(extents.x[0]===Infinity){extents.x[0]=0}if(extents.x[1]===-Infinity){extents.x[1]=1}if(Array.isArray(extents.y)&&extents.y[0]===Infinity){extents.y[0]=0}if(Array.isArray(extents.y)&&extents.y[1]===-Infinity){extents.y[1]=1}if(extents.x[1]===extents.x[0]){extents.x[0]-=.5;extents.x[1]+=.5}if(Array.isArray(extents.y)){if(extents.y[1]===extents.y[0]){extents.y[0]-=.5;extents.y[1]+=.5}}else{var yKeys=Object.keys(extents.y);for(var i=0;i<yKeys.length;i++){if(extents.y[yKeys[i]][0]===extents.y[yKeys[i]][1]){extents.y[yKeys[i]][0]-=.5;extents.y[yKeys[i]][1]+=.5}}}return extents}.bind(extentCalc);extentCalc._checkForExtents=function _checkForExtents(isOrd,chartExtents,dataExtents,axis){var exts=[];if(isOrd){if(dataExtents&&dataExtents[axis]){exts=JSON.parse(JSON.stringify(dataExtents[axis]))}if(chartExtents&&chartExtents[axis]){exts=JSON.parse(JSON.stringify(chartExtents[axis]))}}else{var fromChartExtents=false;exts=this._checkChartExtents(chartExtents,axis);fromChartExtents=exts.length===2?true:false;exts=this._checkDataExtents(dataExtents,chartExtents,axis,fromChartExtents,exts);if(exts.length<2){exts=[this._defaultScaleValue[axis][0],this._defaultScaleValue[axis][1]]}}return exts}.bind(extentCalc);extentCalc._checkChartExtents=function _checkChartExtents(cExts,axis){var exts=[];if(cExts&&cExts[axis]&&cExts[axis].length===2){exts[0]=cExts[axis][0]===\"dynamic\"?Infinity:cExts[axis][0];exts[1]=cExts[axis][1]===\"dynamic\"?-Infinity:cExts[axis][1]}return exts}.bind(extentCalc);extentCalc._checkDataExtents=function _checkDataExtents(dExts,cExts,axis,bool,exts){var result=exts||[];if(dExts&&dExts[axis]&&dExts[axis].length===2){if(bool){result[0]=cExts[axis][0]===\"dynamic\"?dExts[axis][0]:cExts[axis][0];result[1]=cExts[axis][1]===\"dynamic\"?dExts[axis][1]:cExts[axis][1]}else{result[0]=Math.min(dExts[axis][0],this._defaultScaleValue[axis][0]);result[1]=Math.max(dExts[axis][1],this._defaultScaleValue[axis][1])}}return result}.bind(extentCalc);extentCalc._findMinMax=function _findMinMax(data,doX,doY,ordX,ordY,timeX,result,keys){var xVal,yVal,dLen=data.length,x=this.completeSeriesConfig[keys[0]].x,y=this.completeSeriesConfig[keys[0]].y,doX0=!ordX&&result.x[0]===Infinity?true:false,doX1=!ordX&&result.x[1]===-Infinity?true:false,doY0=!ordY&&result.y[0]===Infinity?true:false,doY1=!ordY&&result.y[1]===-Infinity?true:false;if(timeX){this._findTimeMM(result,data,dLen,x,doX0,doX1)}if(doX||doY){for(var i=0;i<dLen;i++){xVal=this._getDataExtents(data[i],keys,\"x\");yVal=this._getDataExtents(data[i],keys,\"y\");if(doX){this._processDataValues(ordX,result,data,\"x\",x,i,doX0,doX1,xVal[0],xVal[1])}if(doY){this._processDataValues(ordY,result,data,\"y\",y,i,doY0,doY1,yVal[0],yVal[1])}}}}.bind(extentCalc);extentCalc._getDataExtents=function _getDataExtents(d,keysArr,axis){var a=[];for(var i=0;i<keysArr.length;i++){var key=keysArr[i],val;if(!this.mutedSeries[keysArr[i]]){val=d[this.completeSeriesConfig[key][axis]];if(val||val===0){a.push(val)}}}return[Math.min.apply(null,a),Math.max.apply(null,a)]}.bind(extentCalc);extentCalc._findTimeMM=function _findTimeMM(result,d,l,x,doMin,doMax){if(doMin){this._setMin(result.x,d[0][x])}if(doMax){this._setMax(result.x,d[l-1][x])}}.bind(extentCalc);extentCalc._setMin=function _setMin(r,d){if(d===null){return}if(isNaN(r[0])||r[0]>d){r[0]=d}}.bind(extentCalc);extentCalc._setMax=function _setMax(r,d){if(d===null){return}if(isNaN(r[1])||r[1]<d){r[1]=d}}.bind(extentCalc);extentCalc._processDataValues=function _processDataValues(isOrd,r,d,axis,key,i,doMin,doMax,v0,v1){if(isOrd){if(r[axis].indexOf(d[i][key])===-1){r[axis].push(d[i][key])}}else{if(doMin){this._setMin(r[axis],v0)}if(doMax){this._setMax(r[axis],v1)}}}.bind(extentCalc);extentCalc._checkInSeriesConfig=function _checkInSeriesConfig(exts,a){for(var i=0;i<this.seriesToAxes[a].length;i++){var s=this.seriesToAxes[a][i];if(!this.hardMute||!this.mutedSeries[s]){exts[a][0]=this.completeSeriesConfig[s][\"yMin\"]||this.completeSeriesConfig[s][\"yMin\"]===0?Math.min(this.completeSeriesConfig[s][\"yMin\"],exts[a][0]):exts[a][0];exts[a][1]=this.completeSeriesConfig[s][\"yMax\"]||this.completeSeriesConfig[s][\"yMax\"]===0?Math.max(this.completeSeriesConfig[s][\"yMax\"],exts[a][1]):exts[a][1]}}}.bind(extentCalc);extentCalc._applyChartExtents=function _applyChartExtents(exts,a){var k=this.chartExtents[a]?a:\"y\";if(this.chartExtents[k]){if(this.chartExtents[k][0]===\"dynamic\"){exts[a][0]=exts[a][0]||exts[a][0]===0?exts[a][0]:Infinity}else{exts[a][0]=this.chartExtents[k][0]}if(this.chartExtents[k][1]===\"dynamic\"){exts[a][1]=exts[a][1]||exts[a][1]===0?exts[a][1]:-Infinity}else{exts[a][1]=this.chartExtents[k][1]}}}.bind(extentCalc);extentCalc._searchForExtents=function _searchForExtents(exts,seriesToSearch,data){var seriesList=Object.keys(seriesToSearch);for(var i=0;i<data.length;i++){for(var j=0;j<seriesList.length;j++){var s=seriesList[j],sY=this.completeSeriesConfig[s][\"y\"],series=seriesToSearch[s],axis=series[\"axis\"];if(series.min&&(data[i][sY]||data[i][sY]===0)){exts[axis][0]=Math.min(data[i][sY],exts[axis][0])}if(series.max&&(data[i][sY]||data[i][sY]===0)){exts[axis][1]=Math.max(data[i][sY],exts[axis][1])}}}}.bind(extentCalc);extentCalc._calcSeriesToSearch=function _calcSeriesToSearch(exts,a,seriesToSearch){for(var i=0;i<this.seriesToAxes[a].length;i++){var s=this.seriesToAxes[a][i];if(!this.hardMute||!this.mutedSeries[s]){seriesToSearch[s]={axis:a,min:exts[a][0]===Infinity?true:false,max:exts[a][1]===-Infinity?true:false}}}}.bind(extentCalc);extentCalc._calcMultiAxisExtents=function _calcMultiAxisExtents(data){var search=false,exts={},seriesToSearch={},a,keys;for(var i=0;i<this.axes.length;i++){a=this.axes[i];exts[a]=[];exts[a][0]=this._defaultScaleValue.y[0];exts[a][1]=this._defaultScaleValue.y[1];this._checkInSeriesConfig(exts,a);if(this.chartExtents){this._applyChartExtents(exts,a)}if(exts[a][0]===Infinity||exts[a][1]===-Infinity){search=true;this._calcSeriesToSearch(exts,a,seriesToSearch)}}if(search){this._searchForExtents(exts,seriesToSearch,data)}keys=Object.keys(exts);for(var i=0;i<keys.length;i++){if(exts[keys[i]][0]===Infinity||exts[keys[i]][1]===-Infinity){exts[keys[i]]=[0,1]}}return exts}.bind(extentCalc);var dataMapping={},quadtrees={};quadtreeBuilt=false;function reply(data){postMessage({data:data})}function updateData(eventData){dataMapping[eventData.chartId]=eventData.data.chartData;reply(null)}function deleteData(eventData){delete dataMapping[eventData.chartId];delete quadtrees[eventData.chartId];reply(null)}function recreateD3Scale(scaleObj){var result;if(scaleObj.type===\"time\"){result=d3.scaleUtc().nice().range(scaleObj.range).domain(scaleObj.domain)}else if(scaleObj.type===\"timeLocal\"){result=d3.scaleTime().nice().range(scaleObj.range).domain(scaleObj.domain)}else if(scaleObj.type===\"linear\"){result=d3.scaleLinear().nice().range(scaleObj.range).domain(scaleObj.domain)}else if(scaleObj.type===\"scaleBand\"){result=d3.scaleBand().range(scaleObj.range).domain(scaleObj.domain).round(true).paddingInner(.5)}else{result=d3.scalePoint().range(scaleObj.range).domain(scaleObj.domain).padding(.5)}return result}function getMultiScale(visData){var o={},k,axis;for(var i=0;i<visData.keys.length;i++){k=visData.keys[i];axis=visData.isMultiY?visData.completeSeriesConfig[k][\"axis\"][\"id\"]:\"defaultAxis\";if(!o[axis]){o[axis]=recreateD3Scale(visData.y[axis])}}return o}function createDataStub(){return{time:null,timeSeriesKey:null,series:[],rawData:[],timeStamps:[],timeStampsTracker:{},additionalPoints:[]}}function flattenData(visData,d,xScale,yScale,index,arr){for(var i=0;i<visData.keys.length;i++){if(visData.hardMute&&visData.mutedSeries[visData.keys[i]]){continue}var o={},k=visData.keys[i],axis=visData.completeSeriesConfig[k][\"axis\"]?visData.completeSeriesConfig[k][\"axis\"][\"id\"]:\"default\";o[\"i\"]=index;o[\"k\"]=k;if(visData.radial){var pix=calcPixelCoordForRadial(d[visData.completeSeriesConfig[k][\"x\"]],d[visData.completeSeriesConfig[k][\"y\"]],axis,visData);o[\"px\"]=~~pix[0];o[\"py\"]=~~pix[1]}else{o[\"px\"]=~~xScale(d[visData.completeSeriesConfig[k][\"x\"]],axis);o[\"py\"]=~~yScale(d[visData.completeSeriesConfig[k][\"y\"]],axis)}arr.push(o)}return arr}function buildQuadtreeHelperObj(visData,k,index,xScale){var obj={},axis=visData.completeSeriesConfig[k][\"axis\"]?visData.completeSeriesConfig[k][\"axis\"][\"id\"]:null;obj.xKey=visData.completeSeriesConfig[k][\"x\"];obj.yKey=visData.completeSeriesConfig[k][\"y\"];if(visData.radial){var calcPx=function(d){return calcPixelCoordForRadial(d[obj.xKey],d[obj.yKey],axis,visData)};obj.xScale=function(d){return calcPx(d)[0]};obj.yScale=function(d){return calcPx(d)[1]};obj.yScale.index=index}else{obj.yScale=recreateD3Scale(visData.y[axis]);obj.yScale.index=index;obj.xScale=recreateD3Scale(visData.x)}return obj}function adjustAngleForPolarChart(angle,toDegrees,visData){var offset=toDegrees?180:Math.PI;if(!visData.counterClockwise&&!toDegrees||visData.counterClockwise&&toDegrees){angle*=-1}if(visData.useDegrees){if(toDegrees){return angle+offset}else{return angle/360*2*Math.PI+offset}}else{if(toDegrees){return angle/(2*Math.PI)*360+offset}else{return angle+offset}}}function calcPixelCoordForRadial(angle,amp,axis,visData){var yRange=visData.y[axis].range[1]-visData.y[axis].range[0],yDomainTot=visData.y[axis].domain[1]-visData.y[axis].domain[0],pixelAmplitude=yRange*(amp-visData.y[axis].domain[0])/yDomainTot;angle=adjustAngleForPolarChart(angle,false,visData);return[Math.sin(angle)*pixelAmplitude,Math.cos(angle)*pixelAmplitude]}function calcXScale(visData){if(!visData.radial){var x=recreateD3Scale(visData.x);return function(d){return x(d)}}}function calcYScale(visData){if(!visData.radial){var y=getMultiScale(visData);return function(d,axis){return y[axis](d)}}}function createSingleQuadtree(data){var visData=data.data,chartData=dataMapping[data.chartId],flatData,xScale=calcXScale(visData),yScale=calcYScale(visData),quadtree;if(chartData){quadtree=d3.quadtree().extent(visData.extents).x(function(d){return d.px}).y(function(d){return d.py});var allFlat=[];for(var i=0;i<chartData.length;i++){flattenData(visData,chartData[i],xScale,yScale,i,allFlat)}quadtree.addAll(allFlat);return quadtree}else{return null}}function createSeriesQuadtree(data){var visData=data.data,chartData=dataMapping[data.chartId],k,quadtree={},xScale=function(d){return visData.radial?this.xScale(d):this.xScale(d[this.xKey])},yScale=function(d){return visData.radial?this.yScale(d):this.yScale(d[this.yKey])};if(chartData){for(var i=0;i<visData.keys.length;i++){k=visData.keys[i];if(visData.hardMute&&visData.mutedSeries[k]){continue}var obj=buildQuadtreeHelperObj(visData,k,i);quadtree[k]=d3.quadtree().extent(visData.extents).x(xScale.bind(obj)).y(yScale.bind(obj)).addAll(chartData)}return quadtree}else{return null}}function createQuadtree(data){quadtreeBuilt=false;quadtrees[data.chartId]=data.data.searchType===\"pointPerSeries\"?createSeriesQuadtree(data):createSingleQuadtree(data);quadtreeBuilt=true;reply(null,null)}function _getPixelSpaceVal(d,chartScale,key,axis){return axis?chartScale[axis](d[key]):chartScale(d[key])}function calcValueQuadtree(d,x,y){var o={};o[x]=d[x];o[y]=d[y];return o}function calcCoordQuadtree(d,x,y,xScale,yScale,visData,axis){var a=[];if(visData.radial){a=calcPixelCoordForRadial(d[x],d[y],axis,visData)}else{a[0]=xScale(d[x]);a[1]=yScale(d[y])}return a}function calcDataSeriesQuadtree(d,k,xScale,yScale,visData,axis){var x=visData.completeSeriesConfig[k][\"x\"],y=visData.completeSeriesConfig[k][\"y\"];return{coord:calcCoordQuadtree(d,x,y,xScale,yScale,visData,axis),name:k,value:calcValueQuadtree(d,x,y)}}function calcClosestPoint(mousePos,foundPoint,series,time){var pixelX=series.coord[0],pixelY=series.coord[1],currDist=(pixelX-=mousePos[0])*pixelX+(pixelY-=mousePos[1])*pixelY;if(!foundPoint||foundPoint.dist>currDist){return{dist:currDist,time:time,key:series.name}}return foundPoint}function calcDataSingleQuadtree(rawData,k,visData){var x=visData.completeSeriesConfig[k][\"x\"],y=visData.completeSeriesConfig[k][\"y\"],axis=visData.completeSeriesConfig[k][\"axis\"]?visData.completeSeriesConfig[k][\"axis\"][\"id\"]:\"default\",value=calcValueQuadtree(rawData,x,y);return{coord:visData.radial?calcPixelCoordForRadial(value[x],value[y],axis,visData):[visData.xScale(value[x]),visData.yScale[axis](value[y])],name:k,value:value}}function addCrosshairDataQuadtree(dataObj,d,timeData){if(timeData&&!dataObj.timeStampsTracker[d[timeData]]){dataObj.rawData.push(d);dataObj.timeStamps.push(d[timeData]);dataObj.timeStampsTracker[d[timeData]]=true}else if(!timeData){dataObj.rawData.push(d)}return dataObj}function constructDataObj(result,dataObj,k,visData,isSingle,xScale){if(!result||visData.hardMute&&visData.mutedSeries[k]||visData.searchFor===\"point\"&&result.k!==k&&visData.searchType!==\"pointPerSeries\"){dataObj.series.push(emptySeries(k))}else if(isSingle){var rawData=this.dataMapping[visData.chartId][result.i];dataObj.series.push(calcDataSingleQuadtree(rawData,k,visData));if(visData.calcCrosshair&&visData.searchType!==\"allInArea\"){dataObj=addCrosshairDataQuadtree(dataObj,rawData,visData.timeData)}}else{var axis=visData.completeSeriesConfig[k][\"axis\"][\"id\"],yScale=recreateD3Scale(visData.y[axis]),series=calcDataSeriesQuadtree(result,k,xScale,yScale,visData,axis);dataObj.series.push(series);if(visData.timeData){dataObj.closest=calcClosestPoint(visData.mousePos,dataObj.closest,series,result[visData.timeData])}if(visData.calcCrosshair){dataObj=addCrosshairDataQuadtree(dataObj,result,visData.timeData)}}return dataObj}function calcBoxSize(visData){var x0=visData.mousePos[0]-visData.radius,x1=visData.mousePos[0]+visData.radius,y0=visData.mousePos[1]-visData.radius,y1=visData.mousePos[1]+visData.radius;return{x0:x0,x1:x1,y0:y0,y1:y1}}function calcPolygonExtents(polygon){var xExt=d3.extent(polygon,function(d){return d[0]}),yExt=d3.extent(polygon,function(d){return d[1]});return{x0:xExt[0],x1:xExt[1],y0:yExt[0],y1:yExt[1]}}function searchPolygonQuadtree(visData,dataObj,quadtree){var boxSize=calcPolygonExtents(visData.polygon),scanned=0,selected=0;if(visData.polygon.length){quadtree.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){if(!node.length){do{var d=node.data;scanned++;if(d3.polygonContains(visData.polygon,[d.px,d.py])){dataObj=addCrosshairDataQuadtree(dataObj,this.dataMapping[visData.chartId][node.data.i],visData.timeData);selected++}}while(node=node.next);return true}return nodeX0>=boxSize.x1||nodeY0>=boxSize.y1||nodeX1<boxSize.x0||nodeY1<boxSize.y0})}return dataObj}function searchAreaBoxQuadtree(quadtree,visData,dataObj){var boxSize=calcBoxSize(visData);quadtree.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){if(!node.length){do{var d=node.data;if(d.px>=boxSize.x0&&d.px<boxSize.x1&&d.py>=boxSize.y0&&d.py<boxSize.y1){dataObj=addCrosshairDataQuadtree(dataObj,d.data,visData.timeData)}}while(node=node.next)}return nodeX0>=boxSize.x1||nodeY0>=boxSize.y1||nodeX1<boxSize.x0||nodeY1<boxSize.y0});return dataObj}function searchAreaRadiusQuadtree(quadtree,visData,dataObj){var r2=visData.radius*visData.radius,boxSize=calcBoxSize(visData);quadtree.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){if(!node.length){do{if(!visData.hardMute||!visData.mutedSeries[node.data.k]){if(Math.pow(node.data.px-visData.mousePos[0],2)+Math.pow(node.data.py-visData.mousePos[1],2)<=r2){dataObj=addCrosshairDataQuadtree(dataObj,this.dataMapping[visData.chartId][node.data.i],visData.timeData)}}}while(node=node.next)}return nodeX0>=boxSize.x1||nodeY0>=boxSize.y1||nodeX1<boxSize.x0||nodeY1<boxSize.y0});return dataObj}function searchAreaQuadtree(quadtree,visData,dataObj){return visData.radius?searchAreaRadiusQuadtree(quadtree,visData,dataObj):searchAreaBoxQuadtree(quadtree,visData,dataObj)}function buildQtSingleDataObj(visData,dataObj,result){for(var i=0;i<visData.keys.length;i++){dataObj=constructDataObj(result,dataObj,visData.keys[i],visData,true,null)}if(result){dataObj.time=dataMapping[visData.chartId][result.i][visData.timeData];dataObj.timeSeriesKey=visData.searchFor===\"point\"?result.k:\"\"}return dataObj}function findAllAtPoint(quadtreeData,point,visData){var allResults=[];quadtreeData.visit(function(node,nodeX0,nodeY0,nodeX1,nodeY1){if(!node.length){do{var d=node.data;if(d.px===point.px&&d.py===point.py){allResults.push(d)}}while(node=node.next)}return nodeX0>point.px||nodeY0>point.py||nodeX1<point.px||nodeY1<point.py});return allResults}function buildAdditionalPoints(visData,allResults,result){var points=[],additionObj,timeStamps={};timeStamps[result.i]=true;for(var i=0;i<allResults.length;i++){if(allResults[i][\"i\"]===result.i&&allResults[i][\"k\"]===result.k){continue}if(visData.searchFor!==\"point\"&&timeStamps[allResults[i][\"i\"]]){continue}additionObj=createDataStub();additionObj=buildQtSingleDataObj(visData,additionObj,allResults[i]);timeStamps[allResults[i][\"i\"]]=true;points.push(additionObj)}return points}function returnAllAtPoint(quadtreeData,visData,result,dataObj){var allResults=findAllAtPoint(quadtreeData,result,visData);if(allResults.length>1){dataObj.additionalPoints=buildAdditionalPoints(visData,allResults,result)}return dataObj}function searchQuadtreeSingle(visData,dataObj,quadtreeData){var r=visData.radius?visData.radius:Infinity,result=quadtreeData.find(visData.mousePos[0],visData.mousePos[1],r);dataObj=buildQtSingleDataObj(visData,dataObj,result);if(result){dataObj=returnAllAtPoint(quadtreeData,visData,result,dataObj)}if(visData.calcCrosshair){if(visData.searchType===\"allInArea\"){dataObj=searchAreaRadiusQuadtree(quadtreeData,visData,dataObj)}}return dataObj}function searchQuadtreeSeries(visData,dataObj,quadtreeData){var r=visData.radius?visData.radius:Infinity,xScale=!visData.radial?recreateD3Scale(visData.x):null,result,k;for(var i=0;i<visData.keys.length;i++){k=visData.keys[i];if(quadtreeData[k]){if(!visData.hardMute||!visData.mutedSeries[k]){result=quadtreeData[k].find(visData.mousePos[0],visData.mousePos[1],r);dataObj=constructDataObj(result,dataObj,k,visData,false,xScale)}}}if(dataObj.closest){dataObj.time=dataObj.closest.time;dataObj.timeSeriesKey=dataObj.closest.key;delete dataObj.closest}return dataObj}function returnClosestsQuadtreePoints(eventData,time){var visData=eventData.data,dataObj=createDataStub(),quadtreeData=quadtrees[eventData.chartId];if(quadtreeData){visData.chartId=eventData.chartId;visData.xScale=recreateD3Scale(visData.x);visData.yScale=getMultiScale(visData);if(visData.searchType===\"pointPerSeries\"){dataObj=searchQuadtreeSeries(visData,dataObj,quadtreeData)}else if(visData.searchType===\"lasso\"){dataObj=searchPolygonQuadtree(visData,dataObj,quadtreeData)}else{dataObj=searchQuadtreeSingle(visData,dataObj,quadtreeData)}}delete dataObj.timeStampsTracker;reply(dataObj)}function returnQuadtreePointsInArea(eventData){var visData=eventData.data,quadtreeData=quadtrees[eventData.chartId],dataObj=createDataStub();if(quadtreeData){visData.chartId=eventData.chartId;visData.xScale=recreateD3Scale(visData.x);visData.yScale=getMultiScale(visData);dataObj=searchAreaBoxQuadtree(quadtreeData,visData,dataObj)}reply(dataObj)}function emptySeries(k){return{coord:[],name:k,value:{}}}function addCrosshairData(dataObj,d){if(this.timeData&&!dataObj.timeStampsTracker[d[this.timeData]]){dataObj.rawData.push(d);dataObj.timeStamps.push(d[this.timeData]);dataObj.timeStampsTracker[d[this.timeData]]=true}else if(!this.timeData){dataObj.rawData.push(d)}return dataObj}function determineExtents(eventData){var visData=eventData.data,extents=null;extentCalc.xAxisType=visData.xAxisType;extentCalc.yAxisType=visData.yAxisType;extentCalc.completeSeriesConfig=visData.completeSeriesConfig;extentCalc.chartExtents=visData.chartExtents;extentCalc.dataExtents=visData.dataExtents;extentCalc.axes=visData.axes;extentCalc.seriesToAxes=visData.seriesToAxes;extentCalc.isYAxisObject=visData.isYAxisObject;extentCalc.mutedSeries=visData.mutedSeries;extentCalc.hardMute=visData.hardMute;if(dataMapping[eventData.chartId]){extents=extentCalc.determineExtents(dataMapping[eventData.chartId])}reply(extents)}onmessage=function(e){switch(e.data.action){case\"registerCustomScript\":if(e.data.data.url){importScripts(e.data.data.url)}reply(null);break;case\"runCustomFunction\":var obj=this[e.data.data.objectName],func,result;if(obj){func=obj[e.data.data.functionName];if(func){result=func(e.data.data.data,e.data.chartId)}else{throw\"Couldn't run custom function \"+e.data.data.functionName+\" on custom Object \"+e.data.data.objectName+\" because the specified function doesn't exist on the specified Object.\"}}else{throw\"Couldn't run custom function \"+e.data.data.functionName+\" on custom Object \"+e.data.data.objectName+\" because the specified Object doesn't exist. Make sure you have loaded your custom script defining the custom object.\"}reply(result);break;case\"updateData\":updateData(e.data);break;case\"createQuadtree\":createQuadtree(e.data);break;case\"findQuadtreePoints\":if(quadtreeBuilt){returnClosestsQuadtreePoints(e.data)}else{reply(null)}break;case\"findQuadtreePointsInArea\":if(quadtreeBuilt){returnQuadtreePointsInArea(e.data)}else{reply(null)}break;case\"returnQuadtreeData\":if(quadtreeBuilt){reply(quadtrees[e.data.chartId])}else{reply(null)}break;case\"determineExtents\":determineExtents(e.data);break;case\"unregisterChart\":deleteData(e.data);break;default:reply(null)}};"}; 
    //end of blob
    //!!!!!!!!DO NOT DELETE COMMENT ABOVE, USED BY GULP FOR INSERTING THE BLOB
    Px.vis.blobUrl = window.URL.createObjectURL(new Blob([blob.script]));

    scheduler.workers = [];
    scheduler.queue = [];
    //mapping between chart and webworker: {chartId: webWorkerIndex}
    scheduler.chartWorkerMapping = {};
    scheduler.hasChartData = {};

    //each chart will always use the same web worker. This is to get around
    //the problem of passing a lot of data around, so the thread will have
    //to keep the data for charts in sync
    getWorkerIndexForChart = function(chartId) {

      //if this chart  hasn't been registered yet do it
      if(!scheduler.chartWorkerMapping[chartId] && scheduler.chartWorkerMapping[chartId] !== 0) {
        //crudely "balance" workload by distributing charts equally among threads.
        var mappingKeys = Object.keys(scheduler.chartWorkerMapping),
            workerChartCount = [],
            minCount = Number.MAX_VALUE,
            workerIndex = 0;

        for(var k=0; k<scheduler.workers.length; k++) {
          workerChartCount.push(0);
        }

        for(var i=0; i<mappingKeys.length; i++) {
          //count the number of charts for each worker
            workerChartCount[scheduler.chartWorkerMapping[mappingKeys[i]]]++;
        }

        //pick the web worker with the least charts
        for(var j=0; j<workerChartCount.length; j++) {
          if(workerChartCount[j] < minCount) {
            minCount = workerChartCount[j];
            workerIndex = j;
          }
        }

        //finally assign the worker index for the chart
        scheduler.chartWorkerMapping[chartId] = workerIndex;
      }

      return scheduler.chartWorkerMapping[chartId];
    }

    startWork = function(worker, ctx) {
      worker.inUse = true;

      //don't copy the callback around, just remember it
      worker.ctx = {};
      worker.ctx.successCallback = ctx.successCallback;
      worker.ctx.errorCallback = ctx.errorCallback;
      worker.ctx.action = ctx.action;
      worker.ctx.chartId = ctx.chartId;
      worker.ctx.originatorName = ctx.originatorName;

      window.dispatchEvent(new CustomEvent('px-vis-scheduler-work-start', {'detail': { 'action': ctx.action, 'data': ctx.data, 'chartId': ctx.chartId, 'originatorName': ctx.originatorName}}));
      worker.postMessage({ 'action': ctx.action, 'data': ctx.data, 'chartId': ctx.chartId});
    }

    /**
     * Method to request some work from the web worker. The context object
     * can have the following properties:
     * - action: action to be run in the webworker. See below for list of actions
     * - originatorName: arbitrary string representing who sent the request
     * - chartId: Id of the chart this request relates to. Used to identify which webworker to use and what dataset to use in the webworker
     * - successCallback (optional): callback after successfully running an action in the webworker. The callback will have one parameter holding the result of that action
     * - errorCallback (optional): Callback after an error has been fired during the webworker.
     *
     * Please note successCallback and errorCallback are mutually exclusive:
     * one will be called or the other. If both are defined you are guaranteed
     * to have feedback on your request
     *
     * Each request is uniquely identified through the triplet "action
     * originatorName chartId". When a webworker is busy and a request comes
     * in for this webworker then the request will be queued. If another
     * request with the same triplet identifier comes in it will trump the
     * previously queued request: the request initially queued will be
     * destroyed and the new one will be queued
     *
     * The current list of significant actions is as follows (more can be
     * found by inspecting px-vis-worker.js but are usually meant to be used
     * internally):
     * - runCustomFunction: used to run a function on a custom script that you
 explicitely loaded in the web workers through Px.vis.registerCustomScript. Pass "functionName" and "objectName" in the "data" object of the context
     * - updateData: register a new dataset or update a dataset in the web worker. It will be stored in the dataMapping object, the key being chartId and the value the dataset. pass "chartData" in the data object
     *
     */
    scheduler.process = function(context) {

      //find worker for this chart
      var worker = scheduler.workers[getWorkerIndexForChart(context.chartId)]

      startOrQueueWork(context, worker);
    };

    startOrQueueWork = function(context, worker) {
      // check if we have run updateData before so we can stick stuff in a queue if not
      var hasData = scheduler.hasChartData[context.chartId] ?
      scheduler.hasChartData[context.chartId] : (context.action === 'updateData');

      //start work or queue
      if(!worker.inUse && (hasData || context.action === 'unregisterChart')) {

        scheduler.hasChartData[context.chartId] = hasData;
        startWork(worker, context);

      } else {
        //worker not available, queue
        var obj,
            found;

        //if we already have an action of this type for this chart remove the old one and replace it with this one
        for(var i=0; i<scheduler.queue[worker.index].length; i++) {

          var obj = scheduler.queue[worker.index][i];
          if(obj.chartId === context.chartId && obj.action === context.action && obj.originatorName === context.originatorName) {
            found = i;
            break;
          }
        }

        if(found || found === 0) {
          scheduler.queue[worker.index].splice(found, 1);
        }

        //now queue
        scheduler.queue[worker.index].push(context);
      }
    };

    //called once a worker has finished a piece of work
    processDone = function(e) {

      window.dispatchEvent(new CustomEvent('px-vis-scheduler-work-end', {'detail': { 'action': this.ctx.action, 'data': e.data.data, 'chartId': this.ctx.chartId, 'originatorName': this.ctx.originatorName}}));

      //store callback and kick off new work before processing results
      var callback = this.ctx.successCallback;

      //cleanup if chart has been unregistered
      if(this.ctx.action === 'unregisterChart') {
        //TODO: clean queues in case something has been added while deleting?
        delete scheduler.chartWorkerMapping[this.ctx.chartId];
        delete scheduler.hasChartData[this.ctx.chartId];

        //clear everything related to this chart
        scheduler.queue[this.index] = scheduler.queue[this.index].filter(function(elem) {
          return elem.chartId !== this.ctx.chartId;
        }.bind(this));
      }

      this.inUse = false;



      //use thread if work queued
      if(scheduler.queue[this.index].length) {

        //get and do work
        var ctx = scheduler.queue[this.index].splice(0, 1)[0];
        startOrQueueWork(ctx, this);
      }
      //run callback with the result
      if(callback) {
        callback(e.data);
      }
    };

    webWorkerError = function(e) {

      window.dispatchEvent(new CustomEvent('px-vis-scheduler-work-error', { 'detail': { 'action': this.ctx.action, 'chartId': this.ctx.chartId, 'originatorName': this.ctx.originatorName}}));

      //cleanup if chart has been unregistered
      if(this.ctx.action === 'unregisterChart') {
        //TODO: clean queues in case something has been added while deleting?
        delete scheduler.chartWorkerMapping[this.ctx.chartId];
      }

      //store callback and kick off new work before processing results
      var callback = this.ctx.errorCallback;

      //use thread if work queued
      if(scheduler.queue[this.index].length) {

        //get and do work
        var ctx = scheduler.queue[this.index].splice(0, 1)[0];
        startWork(this, ctx);
      } else {
        this.inUse = false;
      }

      if(callback) {
        callback();
      }
    };

    //create workers and init queue
    for(var i=0; i<threadCount; i++) {

      try {
        var worker = new Worker(Px.vis.blobUrl);
      } catch(e) {

        //failure
        console.warn('failed to find px-vis web worker file at ' + Px.vis.blobUrl);
        console.warn('the charts won\'t be able to determine their extents or find values')
        return;
      }

      //we can load the worker through a data uri if needed
      scheduler.workers.push(worker);

      worker.inUse = true;
      worker.index = i;
      worker.onmessage = processDone;
      worker.onerror = webWorkerError;
      worker.ctx = {};
      worker.ctx.action = 'init';

      //kick a first dummy communication for each worker.
      //The first comm for each worker is slow (needs to parse script)
      //so do it now in order not to suffer the slowdown when actually needing it
      worker.postMessage({'action': 'init', 'd3Url': Px.vis.workerD3Url});
      scheduler.queue.push([]);
    }

    scheduler.registerCustomScript = function(scriptUrl, successCallback, errorCallback) {

      var regCallback,
          errCallback,
          successCounter = 0,
          errCounter = 0,
          ctx;

      //it should be either all registration will fail or all will succeed
      regCallback = function() {
        successCounter++;
        if(successCounter === scheduler.workers.length) {
          //registration on all ww done
          if(successCallback) {
            successCallback();
          }
        } else if(errCounter > 0 && errorCallback) {
          //got some error, some success... just fire error
          errorCallback();
        }
      };

      errCallback = function() {
        errCounter++;
        if(errCounter === scheduler.workers.length) {
          //all reg failed
          if(errorCallback) {
            errorCallback();
          }

        } else if(successCounter > 0 && errorCallback) {
          //got some error, some success... just fire error
          errorCallback();
        }
      };

      ctx = {
            'action': 'registerCustomScript',
            'data': {
              'url': scriptUrl
            },
            'successCallback': regCallback,
            'errorCallback': errCallback
          };

      //run registration on each worker
      for(var i=0; i<scheduler.workers.length; i++) {
        startWork(scheduler.workers[i], ctx);
      }
    }

    Px.vis.scheduler = scheduler;
    window.dispatchEvent(new CustomEvent('px-vis-worker-ready'));
  }
}());
</script>
